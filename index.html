<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox Env [dev_mode]</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* --- THEME: UTILITY 2000 (SILVER & BLUE) --- */
        :root {
            --bg-root: #808080;
            --panel-face: #f1f1f1;
            --border-light: #fff;
            --border-dark: #404040;
            --highlight: #000080; /* Classic Blue */
            --selection: #ffec8b;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-root);
            font-family: 'Tahoma', 'Verdana', sans-serif;
            font-size: 11px;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- LAYOUT GRID --- */
        #viewport {
            flex: 1; display: flex; padding: 5px; gap: 5px;
            box-sizing: border-box;
        }
        
        /* --- GENERIC WINDOW/PANEL --- */
        .win-box {
            display: flex; flex-direction: column;
            background: var(--panel-face);
            border: 2px solid var(--panel-face);
            border-top-color: var(--border-light);
            border-left-color: var(--border-light);
            border-right-color: var(--border-dark);
            border-bottom-color: var(--border-dark);
        }
        
        .win-header {
            background: linear-gradient(90deg, #000080, #4169e1);
            color: white; padding: 3px 6px;
            font-weight: bold; font-size: 10px;
            display: flex; justify-content: space-between; align-items: center;
            height: 16px;
        }

        .win-content {
            flex: 1; position: relative; overflow: hidden;
            display: flex; flex-direction: column; padding: 2px;
        }

        /* --- LEFT SIDEBAR (Stats + Files) --- */
        aside { width: 240px; display: flex; flex-direction: column; gap: 5px; }

        .meter-group { margin-bottom: 8px; border: 1px dotted #999; padding: 4px; background: #fff; }
        .meter-bar { height: 10px; background: #ddd; border: 1px inset; position: relative; margin-top:2px; }
        .meter-fill { height: 100%; width: 0%; transition: width 0.3s; }
        
        .file-browser {
            flex: 1; background: #fff; border: 2px inset; 
            overflow-y: scroll; list-style: none; padding: 0; margin: 0;
            cursor: default;
        }
        .file-browser li {
            padding: 2px 4px; border-bottom: 1px dotted #eee; 
            display: flex; justify-content: space-between;
        }
        .file-browser li:hover { background: var(--highlight); color: #fff; }
        
        .toolbar { display: flex; gap: 2px; margin-top: 5px; justify-content: center; }
        button {
            border: 1pxoutset; background: #e4e4e4; font-size: 9px; cursor: pointer; padding: 2px 6px;
        }
        button:active { border-style: inset; padding: 3px 5px 1px 7px; } /* Pressed effect */

        /* --- MAIN AREA (Viewer + Term) --- */
        main { flex: 1; display: flex; flex-direction: column; gap: 5px; min-width: 0; }
        
        /* VIEWER/EDITOR AREA */
        #display-port {
            flex: 1; background: #888; border: 2px inset;
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }
        /* When rendering standard content */
        .render-content { 
            width: 100%; height: 100%; overflow: auto; background: white; border: none; 
            display: block;
        }
        /* Text Editor specific */
        textarea.editor-mode {
            width: 100%; height: 100%; box-sizing: border-box; border: none; resize: none;
            font-family: 'Courier New', monospace; font-size: 13px; background: #1a1a1a; color: #0f0;
            padding: 5px; outline: none;
        }
        .editor-bar {
            height: 24px; background: #ccc; border-bottom: 1px solid #999;
            display: flex; align-items: center; padding: 0 5px; gap: 5px;
        }

        /* TERMINAL */
        .term-wrap {
            flex: 1; min-height: 150px; max-height: 300px;
            background: #000; border: 2px inset; 
            padding: 4px; font-family: 'Consolas', monospace; color: #ccc; 
            overflow: hidden; display: flex; flex-direction: column;
        }
        #term-log { flex: 1; overflow-y: scroll; white-space: pre-wrap; font-size: 12px; }
        .cl-green { color: lime; } .cl-yellow { color: yellow; } .cl-red { color: #f55; }
        
        .input-line { display: flex; margin-top: 2px; border-top: 1px solid #333; padding-top:2px; }
        #term-input { 
            flex: 1; background: transparent; color: #fff; border: none; 
            outline: none; font-family: inherit; margin-left: 5px;
        }

    </style>
</head>
<body>

<div id="viewport">
    
    <!-- LEFT PANE -->
    <aside>
        <div class="win-box" style="height: 100%;">
            <div class="win-header">
                <span>SYSTEM & FILES</span>
                <span>x</span>
            </div>
            <div class="win-content">
                <!-- STATS -->
                <div class="meter-group">
                    <div style="display:flex; justify-content:space-between"><span>RAM (Virtual)</span><span id="st-ram">---</span></div>
                    <div class="meter-bar"><div id="br-ram" class="meter-fill" style="background:orange;"></div></div>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:4px;"><span>STORAGE (10GB)</span><span id="st-dsk">0%</span></div>
                    <div class="meter-bar"><div id="br-dsk" class="meter-fill" style="background:navy;"></div></div>
                </div>

                <!-- ACTIONS -->
                <div class="toolbar" style="margin-bottom:4px;">
                    <button id="btn-create" onclick="termInput('create untitled.txt')">NEW</button>
                    <button id="btn-imp" onclick="io.uiUpload()">UPLOAD</button>
                    <button id="btn-fmt" onclick="termInput('format')" style="color:#a00">FORMAT</button>
                    <input type="file" id="sys-up-inv" multiple style="display:none">
                </div>
                
                <!-- LIST -->
                <ul id="file-list" class="file-browser"></ul>
            </div>
        </div>
    </aside>

    <!-- RIGHT PANE -->
    <main>
        
        <!-- VISUAL VIEWER / EDITOR -->
        <div class="win-box" style="flex:2;">
            <div class="win-header">
                <span>ACTIVE DISPLAY</span>
                <span id="disp-fn">idle</span>
            </div>
            <div class="win-content" style="background:#808080; padding:0;">
                <div id="display-port">
                    <div style="display:grid; place-items:center; height:100%; color:#ddd; font-weight:bold; text-shadow:1px 1px 0 #000;">
                        NO ACTIVE PROCESS
                    </div>
                </div>
            </div>
        </div>

        <!-- CLI -->
        <div class="win-box" style="height: auto;">
            <div class="win-header">CMD.EXE</div>
            <div class="term-wrap">
                <div id="term-log">Winbox [Version 3.1.2000]<br>(C) Corp.<br><br>Type "help" for new commands.<br></div>
                <div class="input-line">
                    <span class="cl-green">C:\USERS\ADMIN&gt;</span>
                    <input type="text" id="term-input" autocomplete="off" spellcheck="false" autofocus>
                </div>
            </div>
        </div>

    </main>

</div>

<script>
/** 
 * WINBOX V3 KERNEL
 * Includes Editor, Runner, Downloader
 */

// Global Utils
const $ = (id) => document.getElementById(id);
const termInput = (txt) => { const i = $('term-input'); i.value = txt; i.focus(); };

// Constants
const SYS = {
    DB: 'WINBOX_V3',
    STORE: 'DISK_0',
    LIMIT: 10 * 1024 * 1024 * 1024
};

// ----------------------------------
// 1. TERMINAL SYSTEM
// ----------------------------------
const term = {
    logBox: $('term-log'),
    input: $('term-input'),

    init: function() {
        this.input.addEventListener('keydown', e => {
            if(e.key === 'Enter') this.process();
        });
        window.onclick = () => { if(window.getSelection().toString()==='') this.input.focus(); };
    },

    print: function(txt, cssClass='cl-green') {
        const ln = document.createElement('div');
        ln.innerHTML = txt;
        ln.className = cssClass;
        this.logBox.appendChild(ln);
        this.logBox.scrollTop = this.logBox.scrollHeight;
    },

    process: function() {
        const val = this.input.value.trim();
        if(!val) return;
        this.input.value = '';
        
        this.print(`C:\\> ${val}`, 'white');
        const [cmd, ...args] = val.split(' ');
        const target = args.join(' '); // Rejoin remaining args as filename usually

        // Command Switch
        switch(cmd.toLowerCase()) {
            case 'help':
                this.print("FILESYSTEM CMDs:", "cl-yellow");
                this.print("  ls / dir       : List files");
                this.print("  create [file]  : Create empty file");
                this.print("  edit [file]    : Open Text Editor");
                this.print("  view [file]    : View Image/Text (Read Only)");
                this.print("  run [file]     : Execute HTML/Script");
                this.print("  download [file]: Save to real computer");
                this.print("  rm [file]      : Delete file");
                this.print("  upload         : Import file prompt");
                this.print("  format         : Wipe Disk");
                break;
            case 'cls':
            case 'clear':
                this.logBox.innerHTML = '';
                break;
            case 'ls':
            case 'dir':
                io.list();
                break;
            case 'upload':
                io.uiUpload();
                break;
            case 'create':
            case 'touch':
            case 'mkfile':
                if(!target) return this.print("Error: Specify filename.", "cl-red");
                io.create(target);
                break;
            case 'rm':
            case 'del':
                if(!target) return this.print("Error: Specify filename.", "cl-red");
                io.delete(target);
                break;
            case 'format':
                io.format();
                break;
            case 'run':
            case 'view':
            case 'open':
                if(!target) return this.print("Error: Specify filename.", "cl-red");
                io.load(target, 'view');
                break;
            case 'edit':
            case 'nano':
                if(!target) return this.print("Error: Specify filename.", "cl-red");
                io.load(target, 'edit');
                break;
            case 'download':
            case 'dl':
                if(!target) return this.print("Error: Specify filename.", "cl-red");
                io.download(target);
                break;
            default:
                this.print(`'${cmd}' is not recognized as a command.`, "cl-red");
        }
    }
};

// ----------------------------------
// 2. FILESYSTEM (INDEXED DB)
// ----------------------------------
const io = {
    db: null,

    boot: function() {
        const r = indexedDB.open(SYS.DB, 3);
        r.onupgradeneeded = e => {
            const d = e.target.result;
            if(!d.objectStoreNames.contains(SYS.STORE)) d.createObjectStore(SYS.STORE, { keyPath: 'name' });
        };
        r.onsuccess = e => {
            this.db = e.target.result;
            this.list();
            stats.loop();
            // Bind upload
            $('sys-up-inv').onchange = (ev) => this.handleFiles(ev.target.files);
        };
        r.onerror = () => term.print("DB IO ERROR. Privacy Mode blocks storage?", "cl-red");
    },

    // --- WRITE OPS ---
    save: function(name, blob, silent=false) {
        const tx = this.db.transaction([SYS.STORE], 'readwrite');
        const meta = { name: name, type: blob.type, size: blob.size, data: blob, date: new Date() };
        
        tx.objectStore(SYS.STORE).put(meta);
        tx.oncomplete = () => {
            if(!silent) term.print(`Written: ${name} (${stats.fmt(blob.size)})`);
            this.list();
        };
        tx.onerror = () => term.print(`Write failed: ${name}`, 'cl-red');
    },

    create: function(name) {
        // Create empty text file
        const b = new Blob([""], {type: "text/plain"});
        this.save(name, b);
    },

    delete: function(name) {
        const tx = this.db.transaction([SYS.STORE], 'readwrite');
        tx.objectStore(SYS.STORE).delete(name);
        tx.oncomplete = () => { term.print(`Deleted: ${name}`); this.list(); };
    },

    format: function() {
        if(!confirm("WIPE ALL DATA?")) return;
        const tx = this.db.transaction([SYS.STORE], 'readwrite');
        tx.objectStore(SYS.STORE).clear();
        tx.oncomplete = () => { term.print("Disk formatted."); this.list(); };
    },

    // --- READ OPS ---
    list: function() {
        const ul = $('file-list'); ul.innerHTML = '';
        let total = 0;
        
        const tx = this.db.transaction([SYS.STORE], 'readonly');
        tx.objectStore(SYS.STORE).openCursor().onsuccess = e => {
            const c = e.target.result;
            if(c) {
                total += c.value.size;
                const li = document.createElement('li');
                li.innerHTML = `<span>${c.value.name}</span><small>${stats.fmt(c.value.size)}</small>`;
                li.onclick = () => termInput(`view ${c.value.name}`); // Shortcut
                ul.appendChild(li);
                c.continue();
            } else {
                stats.updDisk(total);
            }
        };
    },

    load: function(name, mode) {
        const tx = this.db.transaction([SYS.STORE], 'readonly');
        tx.objectStore(SYS.STORE).get(name).onsuccess = e => {
            if(e.target.result) ui.render(e.target.result, mode);
            else term.print(`File '${name}' not found.`, 'cl-red');
        };
    },

    download: function(name) {
        const tx = this.db.transaction([SYS.STORE], 'readonly');
        tx.objectStore(SYS.STORE).get(name).onsuccess = e => {
            const res = e.target.result;
            if(res) {
                const url = URL.createObjectURL(res.data);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                term.print(`Downloading: ${name}...`, 'cl-green');
            } else {
                term.print("File not found.", "cl-red");
            }
        };
    },

    // --- UPLOAD HANDLER ---
    uiUpload: () => $('sys-up-inv').click(),

    handleFiles: function(list) {
        if(!list.length) return;
        Array.from(list).forEach(f => {
            // ZIP CHECK
            if(f.name.endsWith('.zip') && window.JSZip) {
                if(confirm(`Unpack ${f.name}?`)) {
                    new JSZip().loadAsync(f).then(zip => {
                        zip.forEach((p, ent) => {
                            if(!ent.dir) ent.async('blob').then(b => this.save(ent.name, b));
                        });
                        term.print("Batch unzip complete.", "cl-green");
                    });
                    return; // Don't save the raw zip
                }
            }
            this.save(f.name, f);
        });
        $('sys-up-inv').value = ""; // Reset
    }
};

// ----------------------------------
// 3. UI RENDERER & EDITOR
// ----------------------------------
const ui = {
    port: $('display-port'),
    lbl: $('disp-fn'),

    render: function(file, mode) {
        this.port.innerHTML = '';
        this.lbl.innerText = file.name + (mode==='edit'?' [EDIT]':' [READ]');

        // EDITOR MODE
        if(mode === 'edit') {
            // Text only check
            if(!file.type.startsWith('text') && !file.name.match(/\.(js|txt|html|css|json|md|log)$/)) {
                return term.print("Cannot edit binary file.", "cl-red");
            }

            // Reader
            const r = new FileReader();
            r.onload = e => {
                const str = e.target.result;
                
                // Build Editor Interface
                const bar = document.createElement('div');
                bar.className = 'editor-bar';
                const saveBtn = document.createElement('button');
                saveBtn.innerText = "SAVE CHANGES";
                
                const area = document.createElement('textarea');
                area.className = 'editor-mode';
                area.value = str;

                // Save Handler
                saveBtn.onclick = () => {
                    const newBlob = new Blob([area.value], {type: 'text/plain'});
                    io.save(file.name, newBlob, true);
                    term.print(`Saved changes to ${file.name}`, 'cl-green');
                };

                bar.appendChild(saveBtn);
                bar.appendChild(document.createTextNode(" (CTRL+S unavailable, click Save)"));
                this.port.appendChild(bar);
                this.port.appendChild(area);
            };
            r.readAsText(file.data);
            return;
        }

        // VIEW/RUN MODE
        if(file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file.data);
            img.style.cssText = "max-width:100%; max-height:100%; object-fit:contain; margin:auto;";
            this.port.appendChild(img);
        }
        else if(file.name.toLowerCase().endsWith('.html') || file.type === 'text/html') {
             // Safe Render in Sandbox Iframe
             const r = new FileReader();
             r.onload = e => {
                 const ifr = document.createElement('iframe');
                 ifr.className = 'render-content';
                 ifr.srcdoc = e.target.result; // "Running" the HTML
                 ifr.sandbox = "allow-scripts"; // allow JS but restrict external
                 this.port.appendChild(ifr);
                 term.print("Executed HTML document.", "cl-green");
             };
             r.readAsText(file.data);
        }
        else if(file.type.startsWith('text/') || file.name.match(/\.(txt|md|js|css|json)$/)) {
            // Read-Only View
            const r = new FileReader();
            r.onload = e => {
                 const pre = document.createElement('pre');
                 pre.className = 'render-content';
                 pre.style.padding = '10px';
                 pre.textContent = e.target.result;
                 this.port.appendChild(pre);
            };
            r.readAsText(file.data);
        }
        else {
             this.port.innerHTML = "<div style='margin:auto;color:#333'>BINARY FILE (Download to view)</div>";
        }
    }
};

// ----------------------------------
// 4. SYSTEM STATS
// ----------------------------------
const stats = {
    loop: function() {
        $('st-ram').innerText = (navigator.deviceMemory||8) + "GB";
        setInterval(() => {
            // Fake fluctuating CPU load
            let h = new Date();
            let n = (h.getSeconds() % 10) * 10 + Math.random()*20;
            $('br-ram').style.width = n + "%";
        }, 1000);
    },
    updDisk: function(used) {
        const p = (used/SYS.LIMIT)*100;
        $('br-dsk').style.width = p + "%";
        $('st-dsk').innerText = this.fmt(used);
    },
    fmt: function(b) {
        if(b<1024) return b+"B";
        if(b<1024*1024) return (b/1024).toFixed(1)+"KB";
        return (b/(1024*1024)).toFixed(1)+"MB";
    }
};

// BOOT
window.onload = () => {
    term.init();
    io.boot();
};
</script>
</body>
</html>
