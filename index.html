<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated CSP: Allows UNPKG scripts/styles, BLOBs for the emulator, and DATA images -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://unpkg.com https://cdnjs.cloudflare.com;">
    <title>Winbox MX [Cloud Engine]</title>
    
    <!-- 1. JSZIP for extracting files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 2. V86 Emulator Engine (Direct from CDN) -->
    <script src="https://unpkg.com/v86@latest/build/libv86.js"></script>

    <style>
        /* --- THEME: INDUSTRIAL MX (2004) --- */
        :root {
            --bg-root: #999;
            --panel-face: #f4f4f4;
            --border: #666;
            --header-grad-1: #e2e2e2;
            --header-grad-2: #cccccc;
            --blue-select: #003399; 
            --font-ui: 'Verdana', sans-serif;
            --font-term: 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-root); font-family: var(--font-ui); font-size: 11px;
            display: flex; flex-direction: column; overflow: hidden;
            user-select: none;
        }

        /* --- HEADER --- */
        #toolbar {
            height: 28px; background: #d0d0d0; border-bottom: 1px solid #777;
            display: flex; align-items: center; padding: 0 8px; gap: 8px; z-index: 10;
        }
        
        .mx-btn {
            background: linear-gradient(#fff, #e0e0e0); border: 1px solid #777;
            padding: 3px 10px; font-size: 10px; color: #222; cursor: pointer;
        }
        .mx-btn:active { background: #ccc; box-shadow: inset 1px 1px 2px #999; }
        
        #clock { margin-left: auto; color: #555; font-size: 10px; }

        /* --- LAYOUT --- */
        #workspace { flex: 1; display: flex; padding: 4px; gap: 4px; overflow: hidden; }

        .panel {
            background: var(--panel-face); border: 1px solid var(--border);
            display: flex; flex-direction: column; 
            box-shadow: 2px 2px 2px rgba(0,0,0,0.1);
        }
        
        .p-head {
            height: 20px; 
            background: linear-gradient(to bottom, var(--header-grad-1), var(--header-grad-2));
            border-bottom: 1px solid #999;
            display: flex; align-items: center; padding: 0 5px;
            font-weight: bold; color: #444; font-size: 10px; text-transform: uppercase;
        }
        .p-head::before { content: "::::"; color: #888; margin-right: 6px; letter-spacing: 1px; }

        .p-body { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }

        /* COLUMNS */
        .col-left { width: 230px; display: flex; flex-direction: column; gap: 4px; }
        .col-center { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .col-right { width: 180px; display: flex; flex-direction: column; gap: 4px; }

        /* --- WIDGETS --- */

        /* Resource Stats */
        .stat-group { padding: 6px; display: flex; flex-direction: column; gap: 5px; background: #f0f0f0; }
        .stat-row { font-size: 9px; color: #666; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .meter-shell { height: 8px; border: 1px solid #999; background: #fff; width: 100%; }
        .meter-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #88b1ff, #316ac5); transition: width 0.3s; }

        /* Module Dock items */
        .mod-item {
            display: flex; gap: 8px; align-items: center; padding: 8px;
            border-bottom: 1px solid #ccc; background: #fff; cursor: default;
        }
        .mod-item.active { background: #eefbff; cursor: pointer; }
        .mod-item.disabled { background: #e0e0e0; color: #888; }

        .chip-icon { 
            width: 24px; height: 24px; background: #333; 
            border: 1px solid #000; display: grid; place-items: center; 
        }
        .chip-led { width: 6px; height: 6px; background: #444; border-radius: 50%; }
        .mod-item.active .chip-led { background: #0f0; box-shadow: 0 0 4px #0f0; }
        
        /* Lists & Console */
        ul#file-index { list-style: none; padding: 0; margin: 0; overflow-y: scroll; flex: 1; background: #fff; border: 1px solid #aaa; }
        ul#file-index li { padding: 2px 5px; border-bottom: 1px dotted #ccc; cursor: pointer; display: flex; justify-content: space-between;}
        ul#file-index li:hover { background: #ddeeff; }

        #term-out { flex:1; background:#fff; overflow-y:auto; border:1px solid #aaa; font-family: var(--font-term); padding:3px; margin-bottom:2px; }
        #term-in { border:1px solid #aaa; background:#eee; font-family: var(--font-term); }

        /* Viewport / Emulator */
        #visual-out {
            width: 100%; height: 100%; background: #000; position: relative;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        /* v86 Canvas scaling */
        #visual-out canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        .hidden { display: none !important; }

    </style>
</head>
<body>

<!-- TOP BAR -->
<div id="toolbar">
    <strong style="color:#555; margin-right:10px;">WINBOX.CLOUD</strong>
    <div style="border-left:1px solid #888; height: 16px;"></div>
    
    <button class="mx-btn" onclick="UI.clickUpload()">Import Assets...</button>
    <button class="mx-btn" onclick="FS.format()" style="color:#900;">Format Disk</button>
    <div id="clock">Running...</div>
</div>

<input type="file" id="sys-upload" class="hidden" multiple>

<!-- 3 COLUMN UI -->
<div id="workspace">

    <!-- LEFT: MONITOR & ASSETS -->
    <div class="col-left">
        <!-- Resource Monitor -->
        <div class="panel" style="height: auto;">
            <div class="p-head">Resources</div>
            <div class="p-body">
                <div class="stat-group">
                    <div class="stat-row"><span>HOST RAM</span><span id="lbl-ram">--</span></div>
                    <div class="meter-shell"><div id="bar-ram" class="meter-fill"></div></div>
                    
                    <div class="stat-row"><span>EMU THREAD</span><span id="lbl-cpu">IDLE</span></div>
                    <div class="meter-shell"><div id="bar-cpu" class="meter-fill"></div></div>
                    
                    <div class="stat-row"><span>VIRTUAL DRIVE</span><span id="lbl-dsk">0%</span></div>
                    <div class="meter-shell"><div id="bar-dsk" class="meter-fill"></div></div>
                </div>
            </div>
        </div>

        <!-- Files -->
        <div class="panel" style="flex:1;">
            <div class="p-head">Asset Index (IDB)</div>
            <div class="p-body" style="padding: 2px;">
                <ul id="file-index"></ul>
            </div>
        </div>
        
        <!-- Log -->
        <div class="panel" style="height: 120px;">
            <div class="p-head">System Log</div>
            <div class="p-body" style="padding: 2px;">
                <div id="term-out">Kernel Loaded.<br>x86 Engine Standing By.</div>
                <input type="text" id="term-in" placeholder=">" autocomplete="off">
            </div>
        </div>
    </div>

    <!-- CENTER: VIEWPORT -->
    <div class="col-center">
        <div class="panel" style="flex:1;">
            <div class="p-head"><span id="stage-lbl">Visual Stage</span></div>
            <div class="p-body">
                <div id="visual-out">
                    <div style="text-align:center; color:#666;">
                        <div style="margin-bottom:10px; font-size:14px; font-weight:bold;">NO ACTIVE OS</div>
                        Import a .img / .iso file<br>Then enable module in right dock.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: MODULE DOCK -->
    <div class="col-right">
        <div class="panel" style="flex: 1;">
            <div class="p-head">Module Dock</div>
            <div class="p-body" style="background:#ddd;">
                
                <!-- BOOTABLE DISK MODULE -->
                <div id="mod-os" class="mod-item disabled">
                    <div class="chip-icon"><div class="chip-led"></div></div>
                    <div style="flex:1; overflow:hidden;">
                        <div style="font-weight:bold; font-size:10px;">OS Bootloader</div>
                        <div style="font-size:9px; color:#666;" id="mod-os-lbl">No Image</div>
                    </div>
                    <button id="btn-run" class="mx-btn hidden" style="padding:1px 6px;">RUN</button>
                </div>
                
                <!-- GENERIC INFO MODULE -->
                <div class="mod-item">
                    <div class="chip-icon"><div class="chip-led" style="background:#888"></div></div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:10px; color:#555;">Cloud BIOS</div>
                        <div style="font-size:9px; color:#666;">SeaBIOS v4 (CDN)</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
/**
 * WINBOX MX KERNEL [Cloud Edition]
 * - Uses Namespaced architecture (App, FS, UI, Term)
 * - Uses UNPKG CDN for emulator files
 * - Uses IndexedDB for storage
 */

const CONFIG = {
    DB: "WINBOX_CLOUD", 
    STORE: "VOL0", 
    OS_MATCH: /\.(img|iso|bin)$/i,
    LIMIT: 10 * 1024 * 1024 * 1024 // 10GB
};

/* --- 1. FILE SYSTEM (INDEXED DB) --- */
const FS = {
    db: null,

    init: async function() {
        return new Promise(resolve => {
            if(!window.indexedDB) return Term.err("No DB Support");
            const req = indexedDB.open(CONFIG.DB, 3);
            req.onupgradeneeded = e => {
                let d = e.target.result;
                if(!d.objectStoreNames.contains(CONFIG.STORE)) d.createObjectStore(CONFIG.STORE, {keyPath:"name"});
            };
            req.onsuccess = e => {
                FS.db = e.target.result;
                FS.scan();
                resolve();
            };
        });
    },

    save: function(name, blob, type) {
        let tx = FS.db.transaction([CONFIG.STORE], "readwrite");
        tx.objectStore(CONFIG.STORE).put({name:name, data:blob, size:blob.size, type:type||blob.type});
        tx.oncomplete = () => FS.scan();
    },

    get: function(name, cb) {
        let tx = FS.db.transaction([CONFIG.STORE], "readonly");
        let r = tx.objectStore(CONFIG.STORE).get(name);
        r.onsuccess = () => cb(r.result || null);
    },

    del: function(name) {
        let tx = FS.db.transaction([CONFIG.STORE], "readwrite");
        tx.objectStore(CONFIG.STORE).delete(name);
        tx.oncomplete = () => { Term.log("Deleted "+name); FS.scan(); };
    },

    format: function() {
        if(!confirm("Format Disk?")) return;
        let tx = FS.db.transaction([CONFIG.STORE], "readwrite");
        tx.objectStore(CONFI
