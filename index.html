<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox MX23</title>
    <!-- Relaxed CSP for local debugging/Blob execution -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' blob: data:;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- OPTIONAL: NATIVE LOAD ATTEMPT (Will fail silently if file missing) -->
    <script src="libv86.js"></script>

    <style>
        /* THEME: INDUSTRIAL */
        :root{--bg:#999;--pan:#f4f4f4;--bor:#666;--hi:#003399;--font:'Verdana';}
        *{box-sizing:border-box} body{background:var(--bg);margin:0;height:100vh;display:flex;flex-direction:column;font:11px var(--font);overflow:hidden;user-select:none;}
        
        /* BAR */
        #top{height:30px;background:#d0d0d0;border-bottom:1px solid #777;display:flex;align-items:center;padding:0 8px;gap:8px;}
        .btn{background:linear-gradient(#fff,#ddd);border:1px solid #777;padding:3px 10px;cursor:pointer;} .btn:active{transform:translateY(1px);}
        
        /* MAIN */
        #wrk{flex:1;display:flex;padding:4px;gap:4px;}
        .col{display:flex;flex-direction:column;gap:4px;}
        .l{width:220px} .c{flex:1} .r{width:180px}
        
        .pan{background:var(--pan);border:1px solid var(--bor);display:flex;flex-direction:column;box-shadow:2px 2px 2px #0002;}
        .ph{height:20px;background:linear-gradient(#eee,#bbb);border-bottom:1px solid #999;display:flex;align-items:center;padding:0 5px;font-weight:bold;}
        
        /* FILE */
        ul#fl{list-style:none;padding:0;margin:0;flex:1;background:#fff;overflow-y:auto;}
        li.it{padding:2px 5px;border-bottom:1px dotted #ccc;cursor:default;}
        li.it:hover{background:#def;} li.it.sel{background:var(--hi);color:#fff;}
        
        /* SCREEN */
        #scr{flex:1;background:#111;display:flex;justify-content:center;align-items:center;position:relative;}
        #scr canvas{display:block;}
        
        /* HW */
        .mod{padding:8px;background:#fff;border-bottom:1px solid #ccc;display:flex;gap:5px;align-items:center;}
        .mod.ok{border-left:3px solid #0f0;}
        .ld{width:8px;height:8px;border-radius:50%;background:#555;}
    </style>
</head>
<body>

<div id="top">
    <b>MX23</b> |
    <button class="btn" id="b-imp">Import Files</button>
    <button class="btn" id="b-rst" style="color:red">Reset</button>
    <span id="stat" style="margin-left:auto;color:#555">Idle</span>
</div>
<input type="file" id="up" hidden multiple>

<div id="wrk">
    <!-- LEFT -->
    <div class="col l">
        <div class="pan" style="flex:1">
            <div class="ph">Explorer</div>
            <ul id="fl"></ul>
        </div>
        <div class="pan" style="height:100px">
            <div class="ph">Log</div>
            <div id="log" style="flex:1;background:#fff;overflow:auto;padding:2px;font-family:monospace"></div>
        </div>
    </div>
    
    <!-- CENTER -->
    <div class="col c">
        <div class="pan" style="flex:1">
            <div class="ph">Display</div>
            <div id="scr"><div style="color:#666">POWER OFF</div></div>
        </div>
    </div>
    
    <!-- RIGHT -->
    <div class="col r">
        <div class="pan" style="flex:1">
            <div class="ph">Hardware Bay</div>
            <div style="background:#ddd;flex:1;padding:5px;">
                
                <!-- ENGINE MODULE -->
                <div id="m-eng" class="mod">
                    <div class="ld" id="l-eng"></div>
                    <div>
                        <b>1. Engine</b><br>
                        <span id="s-eng">Not Loaded</span>
                    </div>
                </div>
                
                <!-- MANUAL INJECTOR -->
                <button id="b-inj" class="btn" style="width:100%;margin-bottom:10px;">INSTALL ENGINE</button>

                <!-- DISK MODULE -->
                <div id="m-os" class="mod">
                    <div class="ld"></div>
                    <div>
                        <b>2. OS Disk</b><br>
                        <span id="s-os">No Media</span>
                    </div>
                </div>

                <div style="height:20px"></div>
                <button id="b-pwr" class="btn" style="width:100%;background:#bbf;font-weight:bold;">POWER ON</button>

            </div>
        </div>
    </div>
</div>

<script>
// MX23 Minimal & Stable
(function(){
    
const DB="WINBOX_V23", ST="F";
const S = { os:null, eng:false };

// --- 1. CORE LOGIC ---
const FS = {
    db:null,
    init:()=>{
        let r=indexedDB.open(DB,1);
        r.onupgradeneeded=e=>e.target.result.createObjectStore(ST,{keyPath:"n"});
        r.onsuccess=e=>{FS.db=e.target.result; FS.scan();};
    },
    put:(f)=>{
        let tx=FS.db.transaction(ST,"readwrite");
        let i={n:f.name, d:f, s:f.size};
        tx.objectStore(ST).put(i).oncomplete=()=>{ Log("Added: "+f.name); FS.scan(); };
    },
    get:(n)=>new Promise(r=>{
        FS.db.transaction(ST,"readonly").objectStore(ST).get(n).onsuccess=e=>r(e.target.result);
    }),
    del:(n)=>{
        FS.db.transaction(ST,"readwrite").objectStore(ST).delete(n).oncomplete=()=>FS.scan();
    },
    scan:()=>{
        let l=document.getElementById("fl"); l.innerHTML="";
        FS.db.transaction(ST,"readonly").objectStore(ST).openCursor().onsuccess=e=>{
            let c=e.target.result;
            if(c){
                let i=c.value;
                let li=document.createElement("li"); li.className="it";
                li.innerHTML=`<span>${i.n}</span><small>${(i.s/1024).toFixed(0)}KB</small>`;
                li.onclick=()=>{
                    if(i.n.match(/\.(img|iso)$/i)) UI.mount(i);
                    document.querySelectorAll(".sel").forEach(e=>e.classList.remove("sel"));
                    li.classList.add("sel");
                };
                li.oncontextmenu=(ev)=>{ev.preventDefault();FS.del(i.n);}
                l.appendChild(li);
                c.continue();
            }
        };
    }
};

// --- 2. ENGINE LOADER (MANUAL INJECTION LOGIC) ---
const Eng = {
    // 2a. Checks if V86 is already in memory
    check:()=>{
        if(window.V86Starter){
            S.eng=true;
            UI.stat("m-eng", "l-eng", "s-eng", "Online", true);
            document.getElementById("b-inj").style.display="none"; // Hide button if ready
            return true;
        }
        return false;
    },
    
    // 2b. Pulls file from IDB and turns it into a script tag
    install: async ()=>{
        Log("Engine: Searching storage for libv86.js...");
        // Look inside IDB for the file
        let f = await FS.get("libv86.js");
        if(f){
            Log("Engine: Found local file. Injecting...");
            
            // Create a virtual URL pointing to the file in RAM
            let blobUrl = URL.createObjectURL(f.d);
            
            let s = document.createElement("script");
            s.src = blobUrl;
            
            s.onload=()=>{
                Log("Engine: INSTALLED.");
                Eng.check();
            };
            s.onerror=()=>Log("ERR: Script failed to parse.");
            
            document.head.appendChild(s);
        } else {
            Log("ERR: libv86.js not found in Explorer.");
            alert("Step 1: Download 'libv86.js' (the code).\nStep 2: Click 'Import Files' and add it.\nStep 3: Click 'INSTALL ENGINE' again.");
        }
    }
};

// --- 3. BOOT ---
async function boot(){
    if(!S.eng) return alert("Install Engine First! (Import libv86.js -> Click Install)");
    if(!S.os) return alert("Select an OS File first (click it in explorer)");

    document.getElementById("scr").innerHTML="";
    Log("Booting: "+S.os.n);

    // Get blobs for hardware (WASM, BIOS)
    // If not found in drive, we try CDN one last time as backup
    let wasm = await FS.get("v86.wasm");
    let bios = await FS.get("seabios.bin");
    let vga  = await FS.get("vgabios.bin");

    // URLs (Prefer Local -> CDN Fallback)
    let u_wasm = wasm ? URL.createObjectURL(wasm.d) : "https://unpkg.com/v86@latest/build/v86.wasm";
    let u_bios = bios ? URL.createObjectURL(bios.d) : "https://unpkg.com/v86@latest/bios/seabios.bin";
    let u_vga  = vga  ? URL.createObjectURL(vga.d)  : "https://unpkg.com/v86@latest/bios/vgabios.bin";

    if(!wasm) Log("Warn: Using CDN for WASM");

    let cfg = {
        wasm_path: u_wasm,
        memory_size: 128*1024*1024, 
        vga_memory_size: 8*1024*1024,
        screen_container: document.getElementById("scr"),
        bios: { url: u_bios },
        vga_bios: { url: u_vga },
        autostart: true
    };

    if(S.os.n.endsWith(".iso")) cfg.cdrom={buffer:S.os.d};
    else cfg.hda={buffer:S.os.d};

    try{
        window.emulator = new V86Starter(cfg);
        Log("VM Running.");
    }catch(e){
        Log("CRASH: "+e.message);
    }
}

// --- UI ---
const UI = {
    mount:(i)=>{
        S.os=i;
        UI.stat("m-os", null, "s-os", i.n, true);
        Log("Mounted: "+i.n);
    },
    stat:(mod, led, txt, str, ok)=>{
        document.getElementById(mod).style.borderLeft=ok?"3px solid #0f0":"1px solid #ccc";
        if(led)document.getElementById(led).style.background=ok?"#0f0":"#555";
        document.getElementById(txt).innerText=str;
    }
};

function Log(t){document.getElementById("log").innerText += "> "+t+"\n";}

window.onload=()=>{
    // Try automatic native check
    if(Eng.check()){ Log("Native drivers loaded."); }
    else { Log("Native drivers missing."); }

    // Button Bindings
    document.getElementById("b-imp").onclick=()=>document.getElementById("up").click();
    document.getElementById("up").onchange=e=>{Array.from(e.target.files).forEach(f=>FS.put(f)); e.target.value="";};
    document.getElementById("b-rst").onclick=()=>{indexedDB.deleteDatabase(DB);location.reload();};
    
    // THE MAGIC BUTTON
    document.getElementById("b-inj").onclick=Eng.install;
    
    document.getElementById("b-pwr").onclick=boot;

    FS.init();
};

})();
</script>
</body>
</html>
