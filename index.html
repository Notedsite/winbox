<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox v2000</title>
    
    <!-- 1. JSZip Library (for unzipping) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* --- FLASH / UTILITY 2000 THEME --- */
        :root {
            --bg-body: #666666;
            --panel-bg: #ece9d8;
            --panel-border: #999;
            --header-grad-1: #3e3e3e;
            --header-grad-2: #222222;
            --text-main: #333;
            --highlight: #316ac5;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-body);
            font-family: 'Verdana', sans-serif;
            font-size: 11px;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        #stage {
            flex: 1; display: flex; padding: 4px; gap: 4px; box-sizing: border-box;
        }

        /* --- PANEL STYLING --- */
        .panel {
            background: var(--panel-bg);
            border: 1px solid #333;
            box-shadow: inset 1px 1px 0px #fff;
            display: flex; flex-direction: column;
        }
        
        .panel-head {
            background: linear-gradient(to bottom, var(--header-grad-1), var(--header-grad-2));
            color: #ddd; padding: 3px 6px;
            font-weight: bold; font-size: 10px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #000;
        }

        .panel-body {
            flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column;
            padding: 4px;
        }

        /* --- SIDEBAR --- */
        .sidebar { width: 220px; display: flex; flex-direction: column; gap: 4px; }
        
        .btn-row { display: flex; gap: 2px; margin-top: 5px; justify-content: flex-end; }
        button {
            background: linear-gradient(#f9f9f9, #e3e3e3);
            border: 1px solid #707070; padding: 3px 8px; cursor: pointer; font-size: 10px;
        }
        button:active { background: #ccc; box-shadow: inset 1px 1px 2px #555; }
        
        /* Stats Meters */
        .meter-container { background: #333; height: 10px; border: 1px inset; margin-bottom: 2px; width: 100%; }
        .meter-fill { height: 100%; width: 0%; transition: width 0.2s; }
        .stat-label { font-size: 9px; color: #555; margin-bottom: 1px; display: flex; justify-content: space-between; }

        /* File Tree */
        ul#file-list {
            list-style: none; padding: 0; margin: 0; background: #fff;
            border: 1px inset; flex: 1; overflow-y: auto; font-family: 'Tahoma', sans-serif;
        }
        ul#file-list li {
            padding: 2px 4px; cursor: pointer; display: flex; justify-content: space-between;
            border-bottom: 1px dashed #eee;
        }
        ul#file-list li:hover { background: var(--highlight); color: white; }

        /* --- MAIN VIEW --- */
        .main-col { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        
        #viewer-frame {
            flex: 2; background: #999; border: 1px inset; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            background-image: repeating-linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc), repeating-linear-gradient(45deg, #ccc 25%, #f0f0f0 25%, #f0f0f0 75%, #ccc 75%, #ccc);
            background-position: 0 0, 10px 10px; background-size: 20px 20px;
        }

        /* --- CONSOLE --- */
        #console-container {
            flex: 1; background: #1a1a1a; color: #00ff00;
            border: 1px inset #000; font-family: 'Courier New', monospace;
            padding: 5px; overflow: hidden; display: flex; flex-direction: column;
        }
        #term-history { flex: 1; overflow-y: scroll; white-space: pre-wrap; font-size: 11px; }
        .msg-sys { color: #aaa; }
        .msg-err { color: #ff5555; }
        .msg-io  { color: #ffff55; }
        
        #term-input-row { display: flex; border-top: 1px solid #444; margin-top: 4px; padding-top: 2px; }
        #term-input { 
            flex: 1; background: transparent; color: #fff; border: none; 
            font-family: inherit; font-size: 12px; outline: none; margin-left: 5px; 
        }

    </style>
</head>
<body>

<div id="stage">
    
    <!-- LEFT PANEL: RESOURCES -->
    <div class="sidebar">
        <!-- SYSTEM STATS -->
        <div class="panel" style="height: auto;">
            <div class="panel-head">SYSTEM RESOURCE MON</div>
            <div class="panel-body">
                <div class="stat-label"><span>MEM LOAD</span><span id="txt-ram">---</span></div>
                <div class="meter-container"><div id="bar-ram" class="meter-fill" style="background:#0c0;"></div></div>

                <div class="stat-label"><span>CPU THREADS</span><span id="txt-cpu">---</span></div>
                <div class="meter-container"><div id="bar-cpu" class="meter-fill" style="background:#cc0;"></div></div>

                <div class="stat-label"><span>DISK USAGE (10GB)</span><span id="txt-disk">calc...</span></div>
                <div class="meter-container"><div id="bar-disk" class="meter-fill" style="background:#00f;"></div></div>
                
                <div class="btn-row">
                    <button id="btn-fmt" style="color:#a00;">FORMAT DSK</button>
                    <button id="btn-up">IMPORT DATA</button>
                    <input type="file" id="inp-file" multiple style="display:none;">
                </div>
            </div>
        </div>
        
        <!-- FILE BROWSER -->
        <div class="panel" style="flex: 1;">
            <div class="panel-head">LOCAL INDEX [DRIVE A]</div>
            <div class="panel-body">
                <ul id="file-list">
                    <!-- JS Populates this -->
                    <li style="color:#666; font-style:italic; padding:5px;">Initializing DB...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- MAIN PANEL -->
    <div class="main-col">
        <!-- VIEWER -->
        <div class="panel" style="flex: 2;">
            <div class="panel-head">VIEWPORT RENDERER</div>
            <div class="panel-body" style="padding:0; background:#333;">
                <div id="viewer-frame">
                    <span style="color:#555; font-weight:bold;">NO SIGNAL</span>
                </div>
            </div>
        </div>

        <!-- CONSOLE -->
        <div class="panel" style="flex: 1;">
            <div class="panel-head">SHELL [ROOT ACCESS]</div>
            <div class="panel-body" style="background: #111; padding: 2px;">
                <div id="console-container">
                    <div id="term-history">Winbox Kernel v2.5...<br>Mounting IndexedDB Volume...<br></div>
                    <div id="term-input-row">
                        <span>ADMIN@WINBOX:~$</span>
                        <input type="text" id="term-input" autocomplete="off" autofocus>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- APPLICATION LOGIC -->
<script>
/** 
 *  WINBOX SINGLE-FILE CLIENT
 *  (C) Open Source - Local Storage + Zip Logic + SimStats
 */

/* 1. GLOBALS (Defined strictly to avoid ref errors) */
window.DB_CFG = {
    NAME: 'WINBOX_SYSTEM',
    STORE: 'PARTITION_0',
    LIMIT: 10737418240 // 10 GB
};

window.term = null;
window.io = null;

/* 2. TERMINAL MODULE */
const TermSys = {
    domBox: document.getElementById('term-history'),
    domInp: document.getElementById('term-input'),
    
    init: function() {
        this.domInp.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') this.execute();
        });
        window.addEventListener('click', () => {
             // Keep focus on terminal unless selecting text
             if(window.getSelection().toString() === '') this.domInp.focus();
        });
        this.log("Terminal Interface Ready.", "sys");
    },

    log: function(msg, type="") {
        const time = new Date().toLocaleTimeString('en-US', {hour12:false});
        const line = document.createElement('div');
        
        if (type === "err") line.className = "msg-err";
        else if (type === "io") line.className = "msg-io";
        else line.className = "msg-sys";
        
        line.textContent = `[${time}] ${msg}`;
        this.domBox.appendChild(line);
        this.domBox.scrollTop = this.domBox.scrollHeight;
    },

    execute: function() {
        const val = this.domInp.value.trim();
        if (!val) return;
        
        this.log(`> ${val}`);
        this.domInp.value = "";
        
        const args = val.split(' ');
        const cmd = args[0].toLowerCase();

        // Basic Shell Router
        if (cmd === 'clear' || cmd === 'cls') {
            this.domBox.innerHTML = "";
        }
        else if (cmd === 'help') {
            this.log("CMDS: ls, rm [file], view [file], format, import, sync", "io");
        }
        else if (cmd === 'ls') {
            io.listDir();
        }
        else if (cmd === 'format') {
            io.formatDisk();
        }
        else if (cmd === 'import') {
            document.getElementById('inp-file').click();
        }
        else if (cmd === 'rm') {
            if(args[1]) io.deleteFile(args[1]);
            else this.log("Missing filename.");
        }
        else if (cmd === 'view') {
            if(args[1]) io.loadFile(args[1]);
            else this.log("Missing filename.");
        }
        else {
            this.log("Unknown Command.", "err");
        }
    }
};

/* 3. IO / FILESYSTEM MODULE */
const IoSys = {
    db: null,

    init: async function() {
        if (!window.indexedDB) return term.log("CRITICAL: IndexedDB missing!", "err");
        
        const req = indexedDB.open(DB_CFG.NAME, 2);
        
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(DB_CFG.STORE)) {
                db.createObjectStore(DB_CFG.STORE, { keyPath: "name" });
            }
        };

        req.onsuccess = (e) => {
            this.db = e.target.result;
            this.listDir(); // initial scan
            term.log("Filesystem Mounted (Mode: R/W).", "sys");
        };

        req.onerror = () => term.log("DB Access Denied/Blocked.", "err");
        
        this.attachButtonListeners();
    },

    attachButtonListeners: function() {
        document.getElementById('btn-up').addEventListener('click', () => {
             document.getElementById('inp-file').click();
        });
        
        document.getElementById('btn-fmt').addEventListener('click', () => {
             this.formatDisk();
        });

        document.getElementById('inp-file').addEventListener('change', (e) => {
             this.handleIncomingFiles(e.target.files);
             e.target.value = ''; // reset
        });
    },

    handleIncomingFiles: function(files) {
        if (files.length === 0) return;
        Array.from(files).forEach(f => {
            term.log(`STREAM: Receiving ${f.name} (${this.fmtSize(f.size)})`, "io");
            
            // Check for Zip
            if (f.name.endsWith('.zip')) {
                // Read into buffer to parse
                const r = new FileReader();
                r.onload = (evt) => this.processZip(f.name, evt.target.result);
                r.readAsArrayBuffer(f);
            } else {
                // Direct Save
                this.saveToDB(f.name, f.type, f.size, f);
            }
        });
    },

    saveToDB: function(name, type, size, blob) {
        const tx = this.db.transaction([DB_CFG.STORE], "readwrite");
        const store = tx.objectStore(DB_CFG.STORE);
        
        const fileRecord = {
            name: name,
            type: type || 'application/octet-stream',
            size: size,
            data: blob,
            modified: Date.now()
        };
        
        store.put(fileRecord);
        
        tx.oncomplete = () => {
            // Quiet log to not spam on zips
            this.listDir();
        };
        tx.onerror = () => term.log(`Write Error: ${name}`, "err");
    },

    // ZIP LOGIC using JSZip
    processZip: function(filename, buffer) {
        term.log(`PKZIP: Detected archive signature for ${filename}`, "sys");
        
        if (!confirm(`Unpack archive "${filename}"? \nClick OK to extract contents.\nClick Cancel to save as a regular zip file.`)) {
             // User chose to keep as ZIP
             this.saveToDB(filename, 'application/zip', buffer.byteLength, new Blob([buffer]));
             return;
        }

        term.log("PKZIP: Deflating streams...", "io");
        
        if (!window.JSZip) return term.log("ERR: JSZip Library not loaded.", "err");

        new JSZip().loadAsync(buffer).then(zip => {
            let pList = [];
            zip.forEach((path, entry) => {
                if (entry.dir) return; // Skip folder items
                const p = entry.async('blob').then(blob => {
                     // Guess MIME
                     let mime = 'text/plain';
                     if (entry.name.match(/\.(jpg|png|gif|jpeg)$/i)) mime = 'image/png';
                     
                     term.log(`EXTRACT: ${entry.name}`, "sys");
                     this.saveToDB(entry.name, mime, blob.size, blob);
                });
                pList.push(p);
            });
            Promise.all(pList).then(() => term.log("Batch extraction complete.", "sys"));
        }).catch(err => term.log(`Corrupt Archive: ${err}`, "err"));
    },

    deleteFile: function(name) {
        const tx = this.db.transaction([DB_CFG.STORE], "readwrite");
        tx.objectStore(DB_CFG.STORE).delete(name);
        tx.oncomplete = () => {
            term.log(`Deleted ${name}`);
            this.listDir();
        };
    },

    formatDisk: function() {
        if (!confirm("CRITICAL WARNING: Wipe all data?")) return;
        const tx = this.db.transaction([DB_CFG.STORE], "readwrite");
        tx.objectStore(DB_CFG.STORE).clear();
        tx.oncomplete = () => {
            term.log("Filesystem formatted (0% Used).", "sys");
            this.listDir();
        };
    },

    loadFile: function(name) {
        const tx = this.db.transaction([DB_CFG.STORE], "readonly");
        const req = tx.objectStore(DB_CFG.STORE).get(name);
        req.onsuccess = (e) => {
            const res = e.target.result;
            if (res) Viewer.display(res);
            else term.log(`File ${name} not found.`, "err");
        };
    },

    listDir: function() {
        const ul = document.getElementById('file-list');
        ul.innerHTML = "";
        
        const tx = this.db.transaction([DB_CFG.STORE], "readonly");
        const store = tx.objectStore(DB_CFG.STORE);
        let totalBytes = 0;
        
        store.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const f = cursor.value;
                totalBytes += f.size;
                
                const li = document.createElement('li');
                li.innerHTML = `<span>${f.name}</span> <span style="font-size:10px; color:#666">${this.fmtSize(f.size)}</span>`;
                li.onclick = () => this.loadFile(f.name);
                
                ul.appendChild(li);
                cursor.continue();
            } else {
                // Done
                this.updateDiskMeter(totalBytes);
            }
        };
    },

    updateDiskMeter: function(used) {
        const pct = (used / DB_CFG.LIMIT) * 100;
        document.getElementById('bar-disk').style.width = pct + "%";
        document.getElementById('txt-disk').innerText = this.fmtSize(used) + " / 10 GB";
        
        if(pct > 80) term.log("Warning: Disk capacity critical.", "err");
    },

    fmtSize: function(bytes) {
        if(bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
};

/* 4. VISUAL RENDERER */
const Viewer = {
    box: document.getElementById('viewer-frame'),
    
    display: function(fileRecord) {
        this.box.innerHTML = "";
        this.box.style.background = "#fff";
        this.box.style.backgroundImage = "none";
        
        term.log(`RENDER: Decoding ${fileRecord.name}...`, "sys");
        
        const type = fileRecord.type;
        const blob = fileRecord.data;

        // Image
        if (type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            img.style.objectFit = 'contain';
            this.box.appendChild(img);
        }
        // HTML / Code / Text
        else if (type.includes('text') || fileRecord.name.match(/\.(html|css|js|json|md)$/i)) {
             const r = new FileReader();
             r.onload = (e) => {
                 // Check if it's HTML, to render safer via srcdoc if possible
                 if(fileRecord.name.endsWith('.html')) {
                    const frame = document.createElement('iframe');
                    frame.style.width = '100%'; frame.style.height = '100%'; frame.style.border = '0';
                    frame.srcdoc = e.target.result;
                    this.box.appendChild(frame);
                 } else {
                    const pre = document.createElement('pre');
                    pre.style.margin = 0; pre.style.padding = '10px'; pre.style.width='100%'; 
                    pre.style.height='100%'; pre.style.overflow='auto';
                    pre.textContent = e.target.result;
                    this.box.appendChild(pre);
                 }
             };
             r.readAsText(blob);
        }
        else {
            this.box.innerHTML = `<div style="text-align:center; padding:20px;">
                <b>Binary Data</b><br>${IoSys.fmtSize(fileRecord.size)}<br><small>${fileRecord.type}</small>
            </div>`;
        }
    }
};

/* 5. STATS SIMULATION */
function initStats() {
    // RAM
    const ram = (navigator.deviceMemory || 8); 
    document.getElementById('txt-ram').innerText = ram + " GB Alloc";
    document.getElementById('bar-ram').style.width = "40%";

    // CPU
    const cores = (navigator.hardwareConcurrency || 4);
    document.getElementById('txt-cpu').innerText = cores + " Cores";
    
    setInterval(() => {
        // Random flutter for effect
        const base = Math.random() * 20;
        const spike = Math.random() > 0.9 ? 30 : 0;
        const total = 20 + base + spike;
        document.getElementById('bar-cpu').style.width = total + "%";
    }, 1500);
}

/* BOOT SEQUENCE */
window.onload = function() {
    // Publish to window for debugging if needed
    window.term = TermSys;
    window.io = IoSys;

    TermSys.init();
    IoSys.init();
    initStats();
};

</script>
</body>
</html>
