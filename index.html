<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: *;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox Env</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        /* BASE & LAYOUT */
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: #008080; 
            font-family: 'Pixelated MS Sans Serif', Arial, sans-serif;
            overflow: hidden;
            display: flex; gap: 6px; padding: 6px;
            box-sizing: border-box;
        }

        .sidebar { width: 200px; display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
        .main { flex-grow: 1; display: flex; flex-direction: column; gap: 6px; min-width: 0; }
        
        /* WINDOW COMPONENTS */
        .window { display: flex; flex-direction: column; height: 100%; box-shadow: none; }
        .window.fixed { flex-grow: 0; flex-basis: auto; height: auto; }
        .window.flex { flex: 1; min-height: 0; } /* min-height fixes overflow issues in flex children */
        .window-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 4px; }

        /* UI ELEMENTS */
        ul.file-list {
            list-style: none; padding: 0; margin: 0;
            background: #fff; border: 2px inset; flex: 1;
            overflow-y: auto;
            font-size: 13px;
        }
        ul.file-list li {
            padding: 2px 4px; cursor: pointer; border-bottom: 1px dotted #ddd;
            display: flex; justify-content: space-between;
        }
        ul.file-list li:hover { background: #000080; color: #fff; }

        .progress-border { border: 1px inset; background: #c0c0c0; height: 16px; position: relative; }
        .progress-bar { height: 100%; background: #000080; width: 0%; transition: width 0.3s; }

        /* TERMINAL */
        #term-log {
            flex: 1; background: #000; color: lime;
            font-family: 'Courier New', monospace; font-size: 12px;
            overflow-y: scroll; white-space: pre-wrap; padding: 4px;
            border: 2px inset;
        }
        #term-input-line { display: flex; background: #000; border: 2px inset; border-top: 0; padding: 2px; }
        #term-prompt { color: lime; font-family: 'Courier New', monospace; margin-right: 5px; font-weight: bold; }
        #term-cmd { flex: 1; background: transparent; border: none; color: lime; outline: none; font-family: 'Courier New', monospace; }

        /* PREVIEW AREA */
        #preview-stage {
            flex: 1; background: #fff; border: 2px inset;
            overflow: auto; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        /* Specific content renderers */
        #preview-stage img { max-width: 100%; max-height: 100%; }
        #preview-stage pre { 
            margin: 0; width: 100%; height: 100%; 
            overflow: auto; text-align: left; background: #fff; padding: 5px; 
            font-family: 'Courier New', monospace; color: black;
        }
        #preview-stage iframe { width: 100%; height: 100%; border: none; display: block; }
        .preview-msg { color: #666; font-style: italic; }

    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <!-- SYSTEM MANAGER -->
    <div class="window fixed">
        <div class="title-bar"><div class="title-bar-text">SYSTEM</div></div>
        <div class="window-body">
            <div style="margin-bottom:2px">Disk Usage:</div>
            <div class="progress-border"><div id="disk-bar" class="progress-bar"></div></div>
            <div id="disk-text" style="text-align:center; font-size:10px; margin-top:2px">Calc...</div>
            <hr>
            <button onclick="document.getElementById('file-upload').click()">[+] Import File</button>
            <input type="file" id="file-upload" multiple style="display:none" onchange="io.handleUpload(this)">
            <button onclick="io.wipe()" style="margin-top:4px">Format Disk</button>
        </div>
    </div>
    
    <!-- FILE EXPLORER -->
    <div class="window flex">
        <div class="title-bar"><div class="title-bar-text">EXPLORER</div></div>
        <div class="window-body">
            <ul id="file-list" class="file-list"></ul>
        </div>
    </div>
</div>

<!-- WORKSPACE -->
<div class="main">
    <!-- VISUAL RENDERER -->
    <div class="window flex" style="flex: 2;">
        <div class="title-bar">
            <div class="title-bar-text">DISPLAY.EXE</div>
            <div class="title-bar-controls"><button aria-label="Minimize"></button><button aria-label="Maximize"></button></div>
        </div>
        <div class="window-body">
            <div id="preview-stage">
                <div class="preview-msg">System Idle. Use console to 'view' files.</div>
            </div>
        </div>
    </div>

    <!-- TERMINAL -->
    <div class="window flex" style="flex: 1;">
        <div class="title-bar"><div class="title-bar-text">COMMAND PROMPT</div></div>
        <div class="window-body" style="background: #c0c0c0; padding:0;">
            <div id="term-log">WINBOX [Version 1.2]<br>(C) 2025 Github Pages Ed.<br><br>Ready.<br></div>
            <div id="term-input-line">
                <span id="term-prompt">C:\&gt;</span>
                <input type="text" id="term-cmd" autocomplete="off" spellcheck="false">
            </div>
        </div>
    </div>
</div>

<script>
/** 
 *  WINBOX KERNEL 
 *  1. Storage Engine (IndexedDB) 
 *  2. Render Engine (Smart DOM injection)
 *  3. Terminal Shell
 */

const CFG = {
    dbName: "WinboxSystem",
    store: "Root",
    limit: 10737418240 // 10GB
};

/* --- 1. STORAGE --- */
const io = {
    db: null,

    init: function() {
        const req = indexedDB.open(CFG.dbName, 2);
        req.onupgradeneeded = e => {
            let db = e.target.result;
            if(!db.objectStoreNames.contains(CFG.store)) {
                db.createObjectStore(CFG.store, { keyPath: 'name' });
            }
        };
        req.onsuccess = e => {
            this.db = e.target.result;
            this.scan();
        };
        req.onerror = () => term.print("Critical Error: IndexedDB blocked.", "red");
    },

    save: function(fileObj) {
        let tx = this.db.transaction([CFG.store], 'readwrite');
        tx.oncomplete = () => { this.scan(); term.print(`Saved: ${fileObj.name}`); };
        tx.onerror = () => term.print("Write Failed. Quota Exceeded?", "red");
        
        tx.objectStore(CFG.store).put({
            name: fileObj.name,
            type: fileObj.type || 'text/plain', // Default fallback
            size: fileObj.size,
            blob: fileObj,
            lastMod: new Date().toLocaleTimeString()
        });
    },

    load: function(name) {
        let tx = this.db.transaction([CFG.store], 'readonly');
        let req = tx.objectStore(CFG.store).get(name);
        req.onsuccess = () => {
            if(req.result) viewer.render(req.result);
            else term.print("File not found.", "yellow");
        };
    },

    del: function(name) {
        let tx = this.db.transaction([CFG.store], 'readwrite');
        tx.objectStore(CFG.store).delete(name);
        tx.oncomplete = () => { term.print(`Deleted: ${name}`); this.scan(); };
    },

    scan: function() {
        let list = document.getElementById('file-list');
        list.innerHTML = "";
        let sizeAccum = 0;
        
        let tx = this.db.transaction([CFG.store], 'readonly');
        let cursor = tx.objectStore(CFG.store).openCursor();
        
        cursor.onsuccess = e => {
            let ptr = e.target.result;
            if(ptr) {
                let f = ptr.value;
                sizeAccum += f.size;
                
                // Add to UI
                let li = document.createElement('li');
                li.innerHTML = `<span>${f.name}</span> <span style="color:#666">${this.fmt(f.size)}</span>`;
                li.onclick = () => io.load(f.name);
                list.appendChild(li);
                
                ptr.continue();
            } else {
                // Done iterating
                this.updateDiskBar(sizeAccum);
            }
        };
    },

    handleUpload: function(el) {
        Array.from(el.files).forEach(f => this.save(f));
        el.value = ''; // Reset
    },

    wipe: function() {
        if(!confirm("Wipe all data permanently?")) return;
        let tx = this.db.transaction([CFG.store], 'readwrite');
        tx.objectStore(CFG.store).clear();
        tx.oncomplete = () => { this.scan(); term.print("Disk Formatted."); };
    },

    // Utils
    fmt: b => {
        if(b<1024) return b+"B";
        if(b<1024*1024) return (b/1024).toFixed(1)+"KB";
        return (b/(1024*1024)).toFixed(1)+"MB";
    },

    updateDiskBar: function(used) {
        let pct = (used / CFG.limit) * 100;
        document.getElementById('disk-bar').style.width = pct + "%";
        document.getElementById('disk-text').innerText = `${this.fmt(used)} / 10 GB`;
    }
};

/* --- 2. RENDERER (Smart View) --- */
const viewer = {
    stage: document.getElementById('preview-stage'),
    
    render: function(record) {
        term.print(`Opening: ${record.name} (${record.type})`);
        this.stage.innerHTML = ""; // Clear stage
        
        const type = record.type;
        const blob = record.blob;
        const reader = new FileReader();

        // 1. IMAGE
        if(type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            this.stage.appendChild(img);
        } 
        // 2. HTML (Safe Frame)
        else if(type === 'text/html') {
            reader.onload = () => {
                const ifr = document.createElement('iframe');
                // usage of srcdoc prevents standard 'file download' trigger of src=blob
                ifr.srcdoc = reader.result; 
                this.stage.appendChild(ifr);
            };
            reader.readAsText(blob);
        }
        // 3. TEXT / CODE
        else if(type.startsWith('text/') || type.includes('json') || type.includes('javascript') || type === '') {
            reader.onload = () => {
                const pre = document.createElement('pre');
                pre.innerText = reader.result;
                this.stage.appendChild(pre);
            };
            reader.readAsText(blob);
        }
        // 4. UNKNOWN / BINARY
        else {
            this.stage.innerHTML = `<div class='preview-msg'>Binary file. Cannot preview.<br>Type: ${type}</div>`;
        }
    }
};

/* --- 3. TERMINAL SHELL --- */
const term = {
    log: document.getElementById('term-log'),
    cmd: document.getElementById('term-cmd'),

    init: function() {
        this.cmd.addEventListener('keydown', e => {
            if(e.key === 'Enter') this.exec();
        });
        // Click anywhere to focus input
        window.onclick = () => this.cmd.focus();
    },

    print: function(text, color='lime') {
        const ln = document.createElement('div');
        ln.style.color = color;
        ln.innerText = text;
        this.log.appendChild(ln);
        this.log.scrollTop = this.log.scrollHeight;
    },

    exec: function() {
        let val = this.cmd.value.trim();
        if(!val) return;
        this.print(`C:\\> ${val}`, 'silver');
        this.cmd.value = '';

        let parts = val.split(' ');
        let act = parts[0].toLowerCase();
        let arg = parts.slice(1).join(' ');

        if(act === 'help') {
            this.print("ls      : List files");
            this.print("view [f]: View file");
            this.print("rm [f]  : Delete file");
            this.print("cls     : Clear screen");
        } 
        else if (act === 'ls') io.scan();
        else if (act === 'cls') this.log.innerHTML = '';
        else if (act === 'rm' || act === 'del') {
            if(arg) io.del(arg);
            else this.print("Specify filename.");
        } 
        else if (act === 'view' || act === 'open') {
            if(arg) io.load(arg);
            else this.print("Specify filename.");
        }
        else {
            this.print("Bad command.");
        }
    }
};

/* --- BOOT --- */
io.init();
term.init();

</script>
</body>
</html>
