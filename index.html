<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox MX8 [Resourced]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* --- THEME: INDUSTRIAL 2000 --- */
        :root {
            --bg-body: #999;
            --panel-face: #f4f4f4;
            --border: #666;
            --header-light: #e0e0e0;
            --header-dark: #cccccc;
            --accent: #003399; /* Tech Blue */
            --font-ui: 'Verdana', sans-serif;
            --font-mono: 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-body); font-family: var(--font-ui); font-size: 11px;
            display: flex; flex-direction: column; overflow: hidden;
            user-select: none;
        }

        /* --- TOOLBAR --- */
        #toolbar {
            height: 28px; background: #d0d0d0; border-bottom: 1px solid #777;
            display: flex; align-items: center; padding: 0 8px; gap: 8px;
            box-shadow: inset 0 1px 0 #fff; z-index: 5;
        }

        .mx-btn {
            background: linear-gradient(#fff, #ddd); border: 1px solid #777;
            padding: 3px 10px; font-size: 10px; color: #222; cursor: pointer;
        }
        .mx-btn:active { background: #ccc; box-shadow: inset 1px 1px 2px #999; }
        
        #clock { margin-left: auto; color: #555; font-size: 10px; }

        /* --- LAYOUT --- */
        #workspace { flex: 1; display: flex; padding: 4px; gap: 4px; overflow: hidden; }

        .panel {
            background: var(--panel-face); border: 1px solid var(--border);
            display: flex; flex-direction: column; 
            box-shadow: 2px 2px 2px rgba(0,0,0,0.1);
        }
        
        .p-head {
            height: 20px; 
            background: linear-gradient(to bottom, var(--header-light), var(--header-dark));
            border-bottom: 1px solid #999;
            display: flex; align-items: center; padding: 0 5px;
            font-weight: bold; color: #444; font-size: 10px; text-transform: uppercase;
        }
        .p-head::before { content: "::::"; color: #888; margin-right: 6px; letter-spacing: 1px; }

        .p-body { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }

        /* COLUMNS */
        .col-left { width: 230px; display: flex; flex-direction: column; gap: 4px; }
        .col-center { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .col-right { width: 180px; display: flex; flex-direction: column; gap: 4px; }

        /* --- STAT BARS (Resource Center) --- */
        .stat-group { padding: 6px; display: flex; flex-direction: column; gap: 5px; background: #f0f0f0; }
        
        .stat-row { font-size: 9px; color: #666; display: flex; justify-content: space-between; margin-bottom: 2px; }
        
        .meter-shell {
            height: 10px; border: 1px solid #999; background: #fff; width: 100%; position: relative;
        }
        .meter-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #99ccff, #3366cc);
            transition: width 0.4s ease-out;
        }

        /* --- OTHER WIDGETS --- */
        .module-item {
            display: flex; gap: 8px; align-items: center; padding: 8px;
            border-bottom: 1px solid #ccc; cursor: pointer; background: #fff;
            transition: background 0.2s;
        }
        .module-item:hover { background: #eefbff; }
        
        .chip-icon { 
            width: 24px; height: 24px; background: #333; 
            border: 1px solid #000; display: grid; place-items: center; 
        }
        .chip-inner { width: 8px; height: 8px; background: gold; border-radius: 50%; }

        .module-item.is-installed { background: #e0e0e0; cursor: default; }
        .module-item.is-installed .chip-inner { background: #666; }
        
        /* Viewport */
        #stage-wrap {
            flex: 1; border: 1px inset #fff; background: #888; padding: 20px;
            background-image: repeating-linear-gradient(45deg, #999 25%, transparent 25%, transparent 75%, #999 75%, #999);
            background-size: 12px 12px;
        }
        #visual-out {
            width: 100%; height: 100%; background: #fff; box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        ul#file-index { list-style: none; padding: 0; margin: 0; overflow-y: scroll; flex: 1; background: #fff; border: 1px solid #aaa; }
        ul#file-index li { padding: 2px 5px; border-bottom: 1px dotted #ccc; }
        ul#file-index li:hover { background: #eef; cursor: pointer; }

        /* Console */
        #term-out { flex:1; background:#fff; overflow-y:auto; border:1px solid #aaa; margin-bottom:2px; font-family:var(--font-mono); padding:3px; }
        #term-in { border:1px solid #aaa; background:#eee; font-family:var(--font-mono); }

        /* Hidden inputs */
        .hidden { display: none !important; }
        
        /* Fake BIOS Screens */
        .os-boot { background: #000; color: #ddd; width:100%; height:100%; padding:20px; font-family: monospace; }
        .os-gui { background: #008080; width:100%; height:100%; position:relative; }
        .os-win { 
            position:absolute; top:20px; left:20px; width:220px; 
            background: #c0c0c0; border:2px outset #fff; box-shadow: 2px 2px 0 #000; 
        }

    </style>
</head>
<body>

<!-- TOOLBAR -->
<div id="toolbar">
    <div style="font-weight:bold; color:#444; letter-spacing:1px; margin-right: 10px;">WINBOX.MX8</div>
    <div style="border-left:1px solid #888; height: 16px;"></div>
    
    <button class="mx-btn" onclick="UI.upload()">Import Files...</button>
    <button class="mx-btn" onclick="FS.format()" style="color:#a00">Format</button>
    <div id="clock">Running...</div>
</div>

<input type="file" id="sys-shim" class="hidden" multiple>

<!-- LAYOUT -->
<div id="workspace">

    <!-- LEFT: ASSETS & STATS -->
    <div class="col-left">
        <!-- 1. Resource Monitor (Restored!) -->
        <div class="panel" style="height: auto;">
            <div class="p-head">Resource Center</div>
            <div class="p-body">
                <div class="stat-group">
                    
                    <div class="stat-row"><span>SYS MEMORY</span><span id="txt-ram">Init...</span></div>
                    <div class="meter-shell"><div id="bar-ram" class="meter-fill"></div></div>
                    
                    <div class="stat-row"><span>CPU CYCLES</span><span id="txt-cpu">Init...</span></div>
                    <div class="meter-shell"><div id="bar-cpu" class="meter-fill"></div></div>

                    <div class="stat-row"><span>DRIVE SPACE</span><span id="txt-dsk">Init...</span></div>
                    <div class="meter-shell"><div id="bar-dsk" class="meter-fill"></div></div>

                </div>
            </div>
        </div>

        <!-- 2. Asset Library -->
        <div class="panel" style="flex:1;">
            <div class="p-head">Local Assets</div>
            <div class="p-body" style="padding: 2px;">
                <ul id="file-index"></ul>
            </div>
        </div>
        
        <!-- 3. Mini Console -->
        <div class="panel" style="height: 120px;">
            <div class="p-head">SysLog</div>
            <div class="p-body" style="padding: 2px;">
                <div id="term-out">Kernel Ready.</div>
                <input type="text" id="term-in" placeholder="Cmd..." autocomplete="off">
            </div>
        </div>
    </div>

    <!-- CENTER: VIEWPORT -->
    <div class="col-center">
        <div class="panel" style="flex:1;">
            <div class="p-head"><span id="lbl-view">Viewport [Idle]</span></div>
            <div class="p-body">
                <div id="stage-wrap">
                    <div id="visual-out">
                        <div style="text-align:center; color:#999;">
                            NO SIGNAL<br><small>Mount a module from the right.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: MODULE DOCK -->
    <div class="col-right">
        <div class="panel" style="flex: 1;">
            <div class="p-head">Module Bay</div>
            <div class="p-body" style="background:#e4e4e4;">
                
                <!-- BIOS MODULE -->
                <div id="mod-bios" class="module-item" onclick="App.installBIOS()">
                    <div class="chip-icon"><div class="chip-inner"></div></div>
                    <div style="flex:1">
                        <div style="font-weight:bold; font-size:10px;">BIOS Firmware</div>
                        <div style="font-size:9px; color:#666;">Legacy ISO</div>
                    </div>
                    <div id="badge-bios" style="background:#003399; color:#fff; font-size:9px; padding:2px;">INSERT</div>
                </div>

                <!-- Spacer Modules -->
                <div class="module-item is-installed">
                    <div class="chip-icon"><div class="chip-inner" style="background:#555"></div></div>
                    <div>
                        <div style="font-weight:bold; font-size:10px; color:#888;">Network Card</div>
                        <div style="font-size:9px; color:#888;">Hardware</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- LOGIC -->
<script>

/* CONFIG */
const C = {
    DB: "WINBOX_PRO_V8",
    VOL: "DISK_A",
    BIOS_NAME: "BIOS_BOOT.ISO",
    LIMIT: 10 * 1024 * 1024 * 1024 // 10GB
};

/* --- LOGIC CORES --- */
const App = {};
const FS = {};
const UI = {};
const Term = {};
const Stats = {}; // New Stats Logic

/* FILESYSTEM */
FS.db = null;
FS.init = function() {
    return new Promise(resolve => {
        if(!indexedDB) return;
        const r = indexedDB.open(C.DB, 3);
        r.onupgradeneeded = e => {
            const d = e.target.result;
            if(!d.objectStoreNames.contains(C.VOL)) d.createObjectStore(C.VOL, {keyPath:"name"});
        };
        r.onsuccess = e => {
            FS.db = e.target.result;
            FS.scan();
            resolve();
        };
    });
};

FS.write = (name, blob, type) => {
    const tx = FS.db.transaction([C.VOL], "readwrite");
    tx.objectStore(C.VOL).put({name:name, data:blob, size:blob.size, type:type||blob.type});
    tx.oncomplete = () => FS.scan();
};

FS.read = (name, cb) => {
    const tx = FS.db.transaction([C.VOL], "readonly");
    const r = tx.objectStore(C.VOL).get(name);
    r.onsuccess = () => { if(r.result) cb(r.result); else Term.err("File missing"); };
};

FS.delete = (name) => {
    const tx = FS.db.transaction([C.VOL], "readwrite");
    tx.objectStore(C.VOL).delete(name);
    tx.oncomplete = () => { Term.log("Deleted "+name); FS.scan(); };
};

FS.format = () => {
    if(!confirm("Format Disk?")) return;
    const tx = FS.db.transaction([C.VOL], "readwrite");
    tx.objectStore(C.VOL).clear();
    tx.oncomplete = () => { Term.log("Formatted"); FS.scan(); };
};

FS.scan = () => {
    const list = document.getElementById("file-index");
    list.innerHTML = "";
    let biosLocked = false;
    let usedBytes = 0;

    const tx = FS.db.transaction([C.VOL], "readonly");
    tx.objectStore(C.VOL).openCursor().onsuccess = e => {
        const c = e.target.result;
        if(c) {
            const f = c.value;
            usedBytes += f.size;
            if(f.name === C.BIOS_NAME) biosLocked = true;
            
            const li = document.createElement("li");
            li.innerHTML = `<span>${f.name}</span> <span style="color:#aaa">${Stats.fmt(f.size)}</span>`;
            li.onclick = () => App.load(f.name);
            list.appendChild(li);
            c.continue();
        } else {
            // Finish scan
            UI.updateModuleBay(biosLocked);
            Stats.updateDisk(usedBytes);
        }
    };
};

/* APP LOGIC */
App.installBIOS = () => {
    Term.log("Firmware insertion detecting...");
    setTimeout(() => {
        const b = new Blob(["BIOS_BINARY"], {type:'application/octet-stream'});
        FS.write(C.BIOS_NAME, b, 'sys/iso');
        Term.log("BIOS Firmware mounted.");
    }, 400);
};

App.load = (name) => {
    document.getElementById("lbl-view").innerText = "Viewport: " + name;
    FS.read(name, (f) => {
        const stg = document.getElementById("visual-out");
        stg.innerHTML = "";
        
        if(f.name === C.BIOS_NAME) App.bootBIOS(stg);
        else if(f.type.includes('image')) {
            let i = new Image(); i.src = URL.createObjectURL(f.data);
            i.style.maxWidth="100%"; i.style.maxHeight="100%"; stg.appendChild(i);
        } else {
            let r = new FileReader();
            r.onload = e => {
                let p = document.createElement("pre");
                p.innerText=e.target.result.substring(0,600);
                p.style.padding="20px";
                stg.appendChild(p);
            };
            r.readAsText(f.data);
        }
    });
};

App.bootBIOS = (container) => {
    container.innerHTML = `<div class="os-boot">MX BIOS v4.0<br>Checking Memory...<br>Disk: OK<br>Loading...</div>`;
    setTimeout(() => {
        container.innerHTML = `
        <div class="os-gui">
            <div class="os-win">
                <div style="background:navy; color:white; padding:2px; font-weight:bold">Virtual Loader</div>
                <div style="padding:10px; color:black">OS Simulation Running...<br>Mem: 64MB</div>
            </div>
        </div>`;
    }, 1500);
};

/* STATS ENGINE (Restored) */
Stats.init = function() {
    // RAM
    const ram = (navigator.deviceMemory || 8);
    document.getElementById("txt-ram").innerText = ram + " GB (Host)";
    
    // CPU Flutter Loop
    setInterval(() => {
        const c = Math.floor(Math.random() * 40); // 0-40% idle flutter
        const r = Math.floor(Math.random() * 20 + 20); 
        document.getElementById("bar-cpu").style.width = c + "%";
        document.getElementById("bar-ram").style.width = r + "%";
        document.getElementById("txt-cpu").innerText = c + "% Usage";
    }, 1200);
};

Stats.updateDisk = (used) => {
    const p = (used / C.LIMIT) * 100;
    document.getElementById("bar-dsk").style.width = p + "%";
    document.getElementById("txt-dsk").innerText = Stats.fmt(used) + " / 10 GB";
};

Stats.fmt = (b) => {
    if(b==0) return "0B";
    const i = Math.floor(Math.log(b)/Math.log(1024));
    return (b/Math.pow(1024,i)).toFixed(1)+['B','KB','MB','GB'][i];
};


/* UI UTILS */
UI.upload = () => document.getElementById("sys-shim").click();

UI.updateModuleBay = (locked) => {
    const m = document.getElementById("mod-bios");
    const b = document.getElementById("badge-bios");
    if(locked) {
        m.classList.add("is-installed");
        b.style.background = "#666"; b.innerText = "MOUNTED";
    } else {
        m.classList.remove("is-installed");
        b.style.background = "#003399"; b.innerText = "INSERT";
    }
};

Term.log = (t) => {
    const c = document.getElementById("term-out");
    const d = document.createElement("div"); d.innerText="> "+t;
    c.appendChild(d); c.scrollTop=c.scrollHeight;
};

Term.err = (t) => {
    const c = document.getElementById("term-out");
    const d = document.createElement("div"); d.innerText="ERR: "+t; d.style.color="red";
    c.appendChild(d); c.scrollTop=c.scrollHeight;
};

/* BOOT */
window.onload = function() {
    // Clock
    setInterval(() => {
        const d = new Date();
        document.getElementById("clock").innerText = d.getHours() + ":" + d.getMinutes().toString().padStart(2,'0');
    }, 1000);

    // Event Bindings
    document.getElementById("term-in").addEventListener("keydown", e => {
        if(e.key === 'Enter'){ let v=e.target.value.trim(); if(v){ Term.log(v); e.target.value=''; }}
    });
    
    document.getElementById("sys-shim").onchange = e => {
        Array.from(e.target.files).forEach(f => FS.write(f.name, f));
        e.target.value='';
    };

    FS.init();
    Stats.init();
    Term.log("Sys Stats Online.");
};

</script>
</body>
</html>
