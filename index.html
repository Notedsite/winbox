<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox MX [Workbench]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* --- THEME: MACROMEDIA INDUSTRIAL --- */
        :root {
            --bg-body: #999;
            --panel-face: #f4f4f4;
            --border: #666;
            --header-light: #e0e0e0;
            --header-dark: #cccccc;
            --accent: #000080; /* Navy Blue */
            --font-ui: 'Verdana', sans-serif;
            --font-mono: 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-body); font-family: var(--font-ui); font-size: 11px;
            display: flex; flex-direction: column; overflow: hidden;
            user-select: none;
        }

        /* --- HEADER --- */
        #toolbar {
            height: 28px; background: #d0d0d0; border-bottom: 1px solid #777;
            display: flex; align-items: center; padding: 0 8px; gap: 8px;
            box-shadow: inset 0 1px 0 #fff; z-index: 5;
        }

        .mx-btn {
            background: linear-gradient(#fff, #ddd); border: 1px solid #777;
            padding: 3px 10px; font-size: 10px; color: #222; cursor: pointer;
        }
        .mx-btn:active { background: #ccc; box-shadow: inset 1px 1px 2px #999; }
        
        #clock { margin-left: auto; color: #555; font-size: 10px; }

        /* --- 3-COLUMN WORKSPACE --- */
        #workspace { flex: 1; display: flex; padding: 4px; gap: 4px; overflow: hidden; }

        /* Generic Panel */
        .panel {
            background: var(--panel-face); border: 1px solid var(--border);
            display: flex; flex-direction: column; 
            box-shadow: 2px 2px 2px rgba(0,0,0,0.1);
        }
        
        .p-head {
            height: 20px; 
            background: linear-gradient(to bottom, var(--header-light), var(--header-dark));
            border-bottom: 1px solid #999;
            display: flex; align-items: center; padding: 0 5px;
            font-weight: bold; color: #444; font-size: 10px; text-transform: uppercase;
        }
        .p-head::before { content: "::::"; color: #888; margin-right: 6px; letter-spacing: 1px; }

        .p-body { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }

        /* LEFT DOCK: ASSETS & LOGS */
        .col-left { width: 220px; display: flex; flex-direction: column; gap: 4px; }

        /* CENTER DOCK: STAGE */
        .col-center { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        
        /* RIGHT DOCK: INSERT MENU */
        .col-right { width: 180px; display: flex; flex-direction: column; gap: 4px; }

        /* --- COMPONENT STYLES --- */

        /* Module Chips (Right Panel) */
        .module-item {
            display: flex; gap: 8px; align-items: center; padding: 8px;
            border-bottom: 1px solid #ccc; cursor: pointer; background: #fff;
            transition: all 0.2s;
        }
        .module-item:hover { background: #eeffff; }
        
        /* Module Icon */
        .chip-icon { 
            width: 24px; height: 24px; background: #333; 
            border: 1px solid #000; display: grid; place-items: center; 
        }
        .chip-inner { width: 8px; height: 8px; background: gold; border-radius: 50%; }

        .module-meta { flex: 1; display: flex; flex-direction: column; }
        .m-title { font-weight: bold; font-size: 10px; }
        .m-sub { font-size: 9px; color: #777; }
        
        /* Status Badge */
        .m-badge {
            font-size: 9px; padding: 2px 4px; background: var(--accent); color: white; border-radius: 2px;
        }
        
        /* Disabled / Installed State */
        .module-item.is-installed {
            background: #e0e0e0; cursor: default;
        }
        .module-item.is-installed .chip-inner { background: #666; }
        .module-item.is-installed .m-title { color: #888; text-decoration: line-through; }
        .module-item.is-installed .m-badge { background: #999; }

        /* File List */
        ul#file-index {
            list-style: none; padding: 0; margin: 0; flex: 1;
            background: #fff; border: 1px solid #aaa; overflow-y: scroll;
        }
        ul#file-index li {
            padding: 2px 4px; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between;
        }
        ul#file-index li:hover { background: #ddeeff; cursor: pointer; }

        /* Viewport */
        #stage-wrap {
            flex: 1; border: 1px inset #fff; background: #888; padding: 20px;
            background-image: repeating-linear-gradient(45deg, #999 25%, transparent 25%, transparent 75%, #999 75%, #999);
            background-size: 12px 12px;
        }
        #visual-out {
            width: 100%; height: 100%; background: #fff; box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        /* Console */
        #term-view {
            flex: 1; background: #fdfdfd; border: 1px solid #aaa; font-family: var(--font-mono); 
            font-size: 10px; padding: 4px; overflow-y: auto; color: #333; margin: 2px;
        }
        #term-in {
            border: 1px solid #aaa; background: #eee; padding: 2px; outline: none; margin: 0 2px 2px 2px; font-family: inherit;
        }

        /* FAKE OS (When running BIOS) */
        .os-boot { background: #000; color: #ddd; width:100%; height:100%; padding:20px; font-family: monospace; }
        .os-gui { background: #008080; width:100%; height:100%; position: relative; }
        .os-win { 
            position:absolute; top:20px; left:20px; width:220px; 
            background: #c0c0c0; border:2px outset #fff; box-shadow: 2px 2px 0 #000; 
        }
        .os-head { background: #000080; color: #fff; padding: 2px 4px; font-weight: bold; display: flex; justify-content: space-between; }
        .os-body { padding: 10px; color: black; }

        .hidden { display: none !important; }

    </style>
</head>
<body>

<!-- TOOLBAR -->
<div id="toolbar">
    <div style="font-weight:bold; color:#444; letter-spacing:1px; margin-right: 10px;">WINBOX.MX7</div>
    <div style="border-left:1px solid #888; height: 16px;"></div>
    
    <button class="mx-btn" onclick="UI.upload()">Import Files...</button>
    <button class="mx-btn" onclick="FS.format()" style="color:#a00">Format</button>
    <div id="clock">Running...</div>
</div>

<input type="file" id="sys-shim" class="hidden" multiple>

<!-- 3 COLUMN WORKSPACE -->
<div id="workspace">

    <!-- 1. LEFT: ASSETS -->
    <div class="col-left">
        <div class="panel" style="flex:1;">
            <div class="p-head">Local Drive (A:)</div>
            <div class="p-body" style="padding: 2px;">
                <ul id="file-index"></ul>
            </div>
        </div>

        <div class="panel" style="height: 150px;">
            <div class="p-head">Log / Cmd</div>
            <div class="p-body">
                <div id="term-view">
                    <div style="color:gray;">Kernel Loaded...</div>
                </div>
                <input type="text" id="term-in" placeholder="Cmd..." autocomplete="off">
            </div>
        </div>
    </div>

    <!-- 2. CENTER: VIEWPORT -->
    <div class="col-center">
        <div class="panel" style="flex:1;">
            <div class="p-head"><span id="lbl-view">Viewport [Idle]</span></div>
            <div class="p-body">
                <div id="stage-wrap">
                    <div id="visual-out">
                        <div style="text-align:center; color:#999;">
                            NO SIGNAL<br><small>Insert and Run a Module</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. RIGHT: INSERT DOCK (New!) -->
    <div class="col-right">
        <div class="panel" style="flex: 1;">
            <div class="p-head">Module Bay</div>
            <div class="p-body" style="background:#ddd;">
                
                <!-- CHIP: BIOS -->
                <div id="mod-bios" class="module-item" onclick="App.installBIOS()">
                    <div class="chip-icon"><div class="chip-inner"></div></div>
                    <div class="module-meta">
                        <span class="m-title">Standard BIOS</span>
                        <span class="m-sub">v4.51 (ISO)</span>
                    </div>
                    <div class="m-badge" id="badge-bios">INSERT</div>
                </div>

                <!-- Spacer / Fake modules for looks -->
                <div class="module-item is-installed" style="cursor: default;">
                    <div class="chip-icon"><div class="chip-inner" style="background:#555"></div></div>
                    <div class="module-meta">
                        <span class="m-title">VGA Controller</span>
                        <span class="m-sub">Integrated</span>
                    </div>
                    <div class="m-badge" style="background:#888">HARDWARE</div>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- JAVASCRIPT KERNEL -->
<script>

/* CONFIG */
const C = {
    DB: "WINBOX_PRO_V7",
    VOL: "MAIN_DISK",
    BIOS_NAME: "BOOT_SECTOR.ISO"
};

/* NAMESPACES (Prevents ref errors) */
const App = {};
const FS = {};
const UI = {};
const Term = {};

/* FILESYSTEM (IndexedDB) */
FS.db = null;
FS.init = function() {
    return new Promise(resolve => {
        const req = indexedDB.open(C.DB, 2);
        req.onupgradeneeded = e => {
            const d = e.target.result;
            if(!d.objectStoreNames.contains(C.VOL)) d.createObjectStore(C.VOL, {keyPath:"name"});
        };
        req.onsuccess = e => {
            FS.db = e.target.result;
            FS.scan();
            resolve();
        };
    });
};

FS.write = function(name, blob, type) {
    const tx = FS.db.transaction([C.VOL], "readwrite");
    tx.objectStore(C.VOL).put({ name:name, data:blob, size:blob.size, type:type||blob.type });
    tx.oncomplete = () => { FS.scan(); };
};

FS.read = function(name, cb) {
    const tx = FS.db.transaction([C.VOL], "readonly");
    const r = tx.objectStore(C.VOL).get(name);
    r.onsuccess = () => { if(r.result) cb(r.result); else Term.err("File not found"); };
};

FS.delete = function(name) {
    const tx = FS.db.transaction([C.VOL], "readwrite");
    tx.objectStore(C.VOL).delete(name);
    tx.oncomplete = () => { Term.log(`Removed ${name}`); FS.scan(); };
};

FS.format = function() {
    if(!confirm("Erase all virtual data?")) return;
    const tx = FS.db.transaction([C.VOL], "readwrite");
    tx.objectStore(C.VOL).clear();
    tx.oncomplete = () => { Term.log("Drive formatted"); FS.scan(); };
};

FS.scan = function() {
    const list = document.getElementById("file-index");
    list.innerHTML = "";
    
    // Check if BIOS exists to lock button
    let biosFound = false;

    const tx = FS.db.transaction([C.VOL], "readonly");
    tx.objectStore(C.VOL).openCursor().onsuccess = e => {
        const c = e.target.result;
        if(c) {
            const f = c.value;
            if(f.name === C.BIOS_NAME) biosFound = true;

            const li = document.createElement("li");
            li.innerHTML = `<span>${f.name}</span>`;
            li.onclick = () => App.load(f.name);
            list.appendChild(li);
            c.continue();
        } else {
            // End of list
            UI.setBIOSLock(biosFound);
        }
    };
};

/* LOGIC APPLICATION */
App.installBIOS = function() {
    Term.log("Reading Module firmware...");
    // Simulate slight delay
    setTimeout(() => {
        const fakeBlob = new Blob(["BINARY_BIOS_DATA"], {type:'application/octet-stream'});
        FS.write(C.BIOS_NAME, fakeBlob, 'system/iso');
        Term.log("SUCCESS: BIOS Firmware Mounted.");
    }, 500);
};

App.load = function(name) {
    document.getElementById("lbl-view").innerText = "Viewport: " + name;
    FS.read(name, (f) => {
        const stage = document.getElementById("visual-out");
        stage.innerHTML = "";

        if(f.name === C.BIOS_NAME) {
            App.bootSimulation(stage);
        } 
        else if(f.type.includes('image')) {
            let i = new Image(); i.src = URL.createObjectURL(f.data);
            i.style.maxWidth="100%"; i.style.maxHeight="100%";
            stage.appendChild(i);
        } 
        else {
            let r = new FileReader();
            r.onload = e => {
                let p = document.createElement("pre"); 
                p.innerText=e.target.result.substring(0,600);
                p.style.padding="20px";
                stage.appendChild(p);
            };
            r.readAsText(f.data);
        }
    });
};

App.bootSimulation = function(stage) {
    // BIOS SEQ
    stage.innerHTML = `<div class="os-boot">ACME BIOS v1.2<br>Checking RAM... OK<br>Drive A: FOUND<br>Booting...</div>`;
    setTimeout(() => {
        stage.innerHTML = `
            <div class="os-gui">
                <div class="os-win">
                    <div class="os-head"><span>Winbox Loader</span><span>X</span></div>
                    <div class="os-body">
                        OS Layer Initialized.<br><br>
                        Ready for instructions.
                    </div>
                </div>
            </div>`;
    }, 2000);
};

/* UI & CONSOLE */
UI.setBIOSLock = function(isLocked) {
    const mod = document.getElementById("mod-bios");
    const bad = document.getElementById("badge-bios");
    if(isLocked) {
        mod.classList.add("is-installed");
        bad.innerText = "MOUNTED";
    } else {
        mod.classList.remove("is-installed");
        bad.innerText = "INSERT";
    }
};

UI.upload = () => document.getElementById("sys-shim").click();

Term.log = (txt) => {
    const d = document.getElementById("term-view");
    const l = document.createElement("div"); l.innerText="> "+txt;
    d.appendChild(l); d.scrollTop=d.scrollHeight;
};

Term.err = (txt) => {
    const d = document.getElementById("term-view");
    const l = document.createElement("div"); l.innerText="ERR: "+txt; l.style.color="red";
    d.appendChild(l); d.scrollTop=d.scrollHeight;
};

/* BOOT */
window.onload = function() {
    // Events
    const inp = document.getElementById("term-in");
    inp.addEventListener("keydown", e => {
        if(e.key === 'Enter') { 
            let v = inp.value.trim(); 
            if(v){ Term.log(v); inp.value=''; /* Simple Echo */ }
        }
    });

    const shim = document.getElementById("sys-shim");
    shim.onchange = e => {
        Array.from(e.target.files).forEach(f => FS.write(f.name, f));
        shim.value='';
    };

    // Time
    setInterval(() => {
        const d = new Date();
        document.getElementById("clock").innerText = d.getHours()+":"+d.getMinutes().toString().padStart(2,'0');
    }, 1000);

    FS.init();
    Term.log("Workstation Ready.");
};

</script>
</body>
</html>
