<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winbox MX [v14 Hierarchical]</title>
    <!-- Dependencies: CSP Friendly -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://unpkg.com https://copy.sh https://cdnjs.cloudflare.com;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* --- INDUSTRIAL MX THEME --- */
        :root {
            --bg-body: #999;
            --panel-face: #f4f4f4;
            --border: #666;
            --header-grad-1: #ddd;
            --header-grad-2: #c0c0c0;
            --select: #003399;
            --font-ui: 'Verdana', sans-serif;
            --font-mono: 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-body); font-family: var(--font-ui); font-size: 11px;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* TOOLBAR */
        #toolbar {
            height: 32px; background: #d0d0d0; border-bottom: 1px solid #777;
            display: flex; align-items: center; padding: 0 8px; gap: 8px; z-index: 10;
        }
        .mx-btn {
            background: linear-gradient(#fff, #e0e0e0); border: 1px solid #777;
            padding: 4px 10px; font-size: 10px; color: #222; cursor: pointer;
            box-shadow: 1px 1px 0px rgba(0,0,0,0.1); display: flex; align-items: center; gap:4px;
        }
        .mx-btn:active { background: #ccc; box-shadow: inset 1px 1px 2px #999; transform: translateY(1px); }
        .mx-btn img { opacity: 0.7; }
        
        #clock { margin-left: auto; color: #555; }

        /* WORKSPACE */
        #workspace { flex: 1; display: flex; padding: 4px; gap: 4px; overflow: hidden; }

        .panel {
            background: var(--panel-face); border: 1px solid var(--border);
            display: flex; flex-direction: column; box-shadow: 2px 2px 2px rgba(0,0,0,0.1);
        }
        
        .p-head {
            height: 22px; background: linear-gradient(to bottom, var(--header-grad-1), var(--header-grad-2));
            border-bottom: 1px solid #999; display: flex; align-items: center; padding: 0 6px;
            font-weight: bold; color: #444; font-size: 10px; text-transform: uppercase;
        }
        .p-body { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }

        /* --- LEFT COLUMN: FILE MANAGER --- */
        .col-left { width: 280px; display: flex; flex-direction: column; gap: 4px; }
        
        /* Address Bar */
        #fm-addr-bar {
            background: #fff; border-bottom: 1px solid #aaa; padding: 4px; 
            display: flex; align-items: center; gap: 4px; font-size: 10px;
        }
        #path-display { flex:1; background: #fff; border: 1px inset #ccc; padding: 2px 4px; color:#555; }

        /* File Tree */
        ul#file-index { 
            list-style: none; padding: 0; margin: 0; overflow-y: scroll; flex: 1; 
            background: #fff; border: 1px solid #aaa; 
        }
        
        /* List Item Styling */
        li.fs-item {
            padding: 3px 6px; border-bottom: 1px dotted #e0e0e0; cursor: default;
            display: flex; align-items: center; gap: 6px; font-size: 11px;
        }
        li.fs-item:hover { background: #f0f8ff; }
        li.fs-item.selected { background: #003399; color: white; }
        li.fs-item.drag-over { border: 2px solid #003399; background: #ddeeff; }

        .fs-icon { 
            width: 14px; height: 12px; display: inline-block; background-size: contain; background-repeat: no-repeat;
        }
        .ico-folder { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZmlsbD0iI0ZGQzEwNyIgZD0iTTAgNGgxdjExSDV2LTFINXYxMmg2di0xSDh2LTFIMnYtOUgwdi0xeiIvPjxwYXRoIGZpbGw9IiNGRkNBMjgiIGQ9Ik0wIDJmg0VjAuNTUgMCAxIDAuNDUgMSAxdi41TDggNWgzLjVsLjUuNXYxSDF2LTdIMHoiLz48L3N2Zz4='); /* Yellow Folder Placeholder */ background-color: goldenrod; border-radius: 2px; }
        .ico-file   { background-color: #999; border-radius: 1px; width: 10px; height: 12px; position:relative; }
        .ico-file::after { content:''; position:absolute; top:2px; left:2px; right:2px; height:1px; background:#fff; }

        /* --- CENTER COLUMN: VIEWPORT --- */
        .col-center { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        #visual-out { width: 100%; height: 100%; background: #222; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;}
        #visual-out canvas { display: block; width:100%; height:100%; image-rendering: pixelated; }

        /* --- RIGHT COLUMN: DOCK --- */
        .col-right { width: 160px; display: flex; flex-direction: column; gap: 4px; }
        
        /* Modules */
        .mod-item { 
            display: flex; gap: 8px; align-items: center; padding: 8px; background: #fff; border-bottom: 1px solid #ccc;
        }
        .mod-item.active { background: #eff; border-left: 3px solid navy; }
        .chip-led { width:8px; height:8px; background:#444; border-radius:50%; }
        .active .chip-led { background:#0f0; box-shadow:0 0 5px #0f0; }

        .hidden { display: none !important; }
        .stat-bar-shell { height:6px; background:#fff; border:1px solid #888; width:100%; margin-top:2px; }
        .stat-fill { height:100%; background:navy; width:0%; transition: width 0.3s; }

    </style>
</head>
<body>

<div id="toolbar">
    <div style="font-weight:bold; color:#555; margin-right:5px;">WINBOX.MX14</div>
    <div style="border-left:1px solid #888; height:16px;"></div>

    <button id="btn-import" class="mx-btn">Import...</button>
    <button id="btn-mkdir" class="mx-btn" title="New Folder">+ Folder</button>
    <button id="btn-format" class="mx-btn" style="color:#a00;">Format</button>

    <div style="flex:1"></div>
    <div id="clock">Ready</div>
</div>

<input type="file" id="sys-up" class="hidden" multiple>

<div id="workspace">

    <!-- LEFT: FILESYSTEM -->
    <div class="col-left">
        <div class="panel" style="flex:1;">
            <div class="p-head">
                <span>File Explorer</span>
            </div>
            
            <!-- Address Bar -->
            <div id="fm-addr-bar">
                <button class="mx-btn" id="btn-up" style="padding:0 5px;" title="Up One Level">&uarr;</button>
                <div id="path-display">/</div>
            </div>

            <div class="p-body">
                <ul id="file-index"></ul>
            </div>
            <div style="height:24px; background:#e0e0e0; border-top:1px solid #aaa; display:flex; align-items:center; padding:0 5px; font-size:10px; color:#555;">
                <span id="fs-count">0 items</span>
                <span style="margin-left:auto" id="fs-size">0 KB</span>
            </div>
        </div>
        
        <!-- Log Console -->
        <div class="panel" style="height: 120px;">
            <div class="p-head">Activity Log</div>
            <div id="term-out" style="flex:1; background:#fff; overflow-y:auto; padding:4px; font-family:var(--font-mono); font-size:10px;"></div>
        </div>
    </div>

    <!-- CENTER: STAGE -->
    <div class="col-center">
        <div class="panel" style="flex:1;">
            <div class="p-head"><span id="stage-title">Visual Viewport</span></div>
            <div class="p-body">
                <div id="visual-out">
                    <div style="text-align:center; color:#666; font-size:12px;">
                        [ VIEWPORT EMPTY ]<br>
                        Select a file to view.<br>Mount OS image to Boot.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: MODULES -->
    <div class="col-right">
        <!-- Resource Panel -->
        <div class="panel" style="height:auto; padding-bottom:5px;">
            <div class="p-head">Monitor</div>
            <div style="padding:5px; font-size:9px; color:#666;">
                <div>RAM USAGE</div><div class="stat-bar-shell"><div id="bar-ram" class="stat-fill"></div></div>
                <div style="margin-top:4px;">DISK (DB)</div><div class="stat-bar-shell"><div id="bar-disk" class="stat-fill"></div></div>
            </div>
        </div>

        <!-- Modules -->
        <div class="panel" style="flex:1;">
            <div class="p-head">Boot Modules</div>
            <div style="background:#e8e8e8; flex:1;">
                
                <div id="mod-os" class="mod-item">
                    <div class="chip-led"></div>
                    <div>
                        <div style="font-weight:bold; font-size:10px;">OS Bootloader</div>
                        <div id="lbl-os-stat" style="font-size:9px; color:#666;">No Image Found</div>
                    </div>
                </div>
                
                <!-- Run Button (Initially Hidden) -->
                <button id="btn-run" class="mx-btn hidden" style="width:90%; margin:5px auto; background:#bbf; border-color:blue;">BOOT SYSTEM</button>

            </div>
        </div>
    </div>

</div>

<!-- SCRIPT LOGIC -->
<script>
/**
 * WINBOX MX v14 [HIERARCHICAL FS]
 * Architecture: Path-Based Object Storage
 * key: fullPath (e.g. "/System/Config.ini")
 */
(function() {

    // --- LOADER: Engine ---
    function loadEngine() {
        const s = document.createElement("script");
        s.src = "https://unpkg.com/v86@latest/build/libv86.js";
        s.onload = () => { Term.log("x86 Engine Ready"); };
        document.head.appendChild(s);
    }

    // --- CONFIG ---
    const CFG = { 
        DB: "WINBOX_FS_TREE", 
        STORE: "FILES",
        MAX: 10737418240 
    };

    // --- STATE ---
    const State = {
        pwd: "/",        // Current Path
        selected: null,  // Selected File Path
        emuRunning: false,
        bootFile: null,
        instance: null
    };

    // --- FILESYSTEM ---
    const FS = {
        db: null,
        
        init: async () => new Promise(res => {
            if(!indexedDB) return;
            const r = indexedDB.open(CFG.DB, 1);
            r.onupgradeneeded = e => {
                const d = e.target.result;
                if(!d.objectStoreNames.contains(CFG.STORE)) {
                    // keyPath is the FULL PATH "id"
                    d.createObjectStore(CFG.STORE, {keyPath: "id"});
                }
            };
            r.onsuccess = e => {
                FS.db = e.target.result;
                FS.ensureRoot().then(() => {
                    FS.scan();
                    res();
                });
            };
        }),

        ensureRoot: async () => {
            // Ensure "/" folder exists
            return FS.writeFolder("/"); 
        },

        // Helper: Get Path Object (Folder) vs File
        writeFolder: (path) => new Promise(res => {
            // Ensure path ends with /
            if(!path.endsWith("/")) path += "/";
            if(path === "/") return res(); // Root exists virtually
            
            // Calc Name: /Users/Admin/ -> Admin
            const parts = path.split("/").filter(p => p);
            const name = parts[parts.length-1];
            // Parent: /Users/
            const parent = "/" + parts.slice(0, -1).join("/") + (parts.length > 1 ? "/" : "");

            const entry = {
                id: path,
                name: name,
                type: "directory",
                parent: parent,
                size: 0,
                date: new Date()
            };
            const tx = FS.db.transaction([CFG.STORE], "readwrite");
            tx.objectStore(CFG.STORE).put(entry);
            tx.oncomplete = res;
        }),

        writeFile: (path, fileBlob) => new Promise(res => {
            // Full path: /Docs/file.txt
            const parts = path.split("/");
            const name = parts.pop();
            let parent = parts.join("/"); 
            if(!parent.endsWith("/")) parent += "/";

            const entry = {
                id: path,
                name: name,
                type: fileBlob.type || "application/octet-stream",
                parent: parent,
                size: fileBlob.size,
                data: fileBlob,
                date: new Date()
            };

            const tx = FS.db.transaction([CFG.STORE], "readwrite");
            tx.objectStore(CFG.STORE).put(entry);
            tx.oncomplete = () => { res(); };
        }),

        del: (id) => {
            const tx = FS.db.transaction([CFG.STORE], "readwrite");
            // Simple delete. In real recursion we would delete children. 
            // Limitation: Deleting a folder here orphans children (keeps it potato-simple)
            tx.objectStore(CFG.STORE).delete(id);
            tx.oncomplete = () => FS.scan();
        },

        move: (childId, newParentPath) => {
            if(!newParentPath.endsWith("/")) newParentPath += "/";
            
            const tx = FS.db.transaction([CFG.STORE], "readwrite");
            const store = tx.objectStore(CFG.STORE);
            
            store.get(childId).onsuccess = e => {
                const item = e.target.result;
                if(!item) return;

                // Create new ID
                const newId = newParentPath + item.name + (item.type==="directory" ? "/" : "");
                
                if(newId === item.id) return; // Same place

                item.parent = newParentPath;
                item.id = newId;

                // Delete Old -> Put New
                store.delete(childId);
                store.put(item);
                
                tx.oncomplete = () => {
                    Term.log("Moved to " + newParentPath);
                    FS.scan();
                };
            };
        },

        // Scan Current PWD
        scan: () => {
            const ul = document.getElementById("file-index");
            ul.innerHTML = "";
            let count = 0; 
            let totalBytes = 0;
            let bootCandidate = null;

            // Simple cursor scan and filter in memory (fast enough for small IDBs)
            const tx = FS.db.transaction([CFG.STORE], "readonly");
            tx.objectStore(CFG.STORE).openCursor().onsuccess = e => {
                const c = e.target.result;
                if(c) {
                    const item = c.value;
                    totalBytes += item.size || 0;
                    
                    // 1. Bootable check (Global)
                    if(!item.type === "directory" && item.name.match(/\.(img|iso)$/i) && !bootCandidate) {
                        bootCandidate = item;
                    }

                    // 2. Render Check (Only if parent matches PWD)
                    if(item.parent === State.pwd) {
                        UI.addFileItem(ul, item);
                        count++;
                    }

                    c.continue();
                } else {
                    // Finish
                    document.getElementById("path-display").innerText = State.pwd;
                    document.getElementById("fs-count").innerText = count + " items";
                    UI.updateBootStatus(bootCandidate);
                    UI.meter(totalBytes);
                }
            };
        },

        wipe: () => {
            const tx = FS.db.transaction([CFG.STORE], "readwrite");
            tx.objectStore(CFG.STORE).clear();
            tx.oncomplete = () => { State.pwd = "/"; FS.ensureRoot().then(FS.scan); Term.log("Format Complete"); };
        }
    };

    // --- UI MANAGER ---
    const UI = {
        addFileItem: (list, item) => {
            const isDir = item.type === "directory";
            const li = document.createElement("li");
            li.className = "fs-item";
            li.draggable = !isDir; // Allow dragging files
            
            // Icon
            const icon = document.createElement("div");
            icon.className = "fs-icon " + (isDir ? "ico-folder" : "ico-file");
            
            const name = document.createElement("span");
            name.innerText = item.name;
            name.style.flex = 1;

            li.append(icon, name);
            list.appendChild(li);

            // INTERACTIONS
            // 1. Open
            li.addEventListener("dblclick", () => {
                if(isDir) {
                    State.pwd = item.id;
                    FS.scan();
                } else {
                    Viewer.open(item);
                }
            });

            // 2. Select
            li.addEventListener("click", () => {
                document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"));
                li.classList.add("selected");
                State.selected = item;
            });

            // 3. DRAG (Source)
            li.addEventListener("dragstart", (e) => {
                e.dataTransfer.setData("text/plain", item.id);
            });

            // 4. DROP (Target - Only Folders)
            if(isDir) {
                li.addEventListener("dragover", e => { e.preventDefault(); li.classList.add("drag-over"); });
                li.addEventListener("dragleave", e => li.classList.remove("drag-over"));
                li.addEventListener("drop", e => {
                    e.preventDefault();
                    li.classList.remove("drag-over");
                    const srcId = e.dataTransfer.getData("text/plain");
                    if(srcId) FS.move(srcId, item.id);
                });
            }
        },

        updateBootStatus: (item) => {
            const lbl = document.getElementById("lbl-os-stat");
            const btn = document.getElementById("btn-run");
            const mod = document.getElementById("mod-os");
            
            if(item) {
                State.bootFile = item;
                lbl.innerText = item.name + " (" + State.pwd + ")";
                mod.classList.add("active");
                btn.classList.remove("hidden");
            } else {
                State.bootFile = null;
                lbl.innerText = "No OS in Filesystem";
                mod.classList.remove("active");
                btn.classList.add("hidden");
            }
        },

        meter: (b) => {
             const p = (b / CFG.MAX)*100;
             document.getElementById("bar-disk").style.width = p + "%";
        }
    };

    // --- ACTIONS ---
    const Actions = {
        mkdir: () => {
            const name = prompt("Folder Name:");
            if(!name) return;
            const newPath = State.pwd + name + "/";
            FS.writeFolder(newPath).then(FS.scan);
        },
        
        up: () => {
            if(State.pwd === "/") return;
            // Remove last slash, split, remove last dir, join
            const parts = State.pwd.split("/").filter(p => p);
            parts.pop();
            State.pwd = parts.length > 0 ? ("/" + parts.join("/") + "/") : "/";
            FS.scan();
        },

        import: () => document.getElementById("sys-up").click(),
        
        handleFiles: (list) => {
            // Handle multiple files import into Current Dir
            let queue = Array.from(list);
            
            const next = () => {
                if(queue.length === 0) {
                    document.getElementById("sys-up").value = "";
                    FS.scan();
                    return;
                }
                const f = queue.shift();
                Term.log("Import: " + f.name);
                
                // ZIP LOGIC?
                if(f.name.endsWith(".zip") && window.JSZip) {
                   new JSZip().loadAsync(f).then(zip => {
                       // We can try to maintain folder structure from zip?
                       // Simplified: Flatten to current dir for stability, OR try path
                       // Let's implement full paths!
                       
                       const zipPromises = [];
                       zip.forEach((path, entry) => {
                           if(entry.dir) {
                               const dirPath = State.pwd + entry.name; 
                               // Write folder implicitly by writing files? 
                               // Need explicit folder writing.
                               zipPromises.push(FS.writeFolder(dirPath));
                           } else {
                               // file
                               zipPromises.push(entry.async("blob").then(b => {
                                   const fullPath = State.pwd + entry.name; 
                                   // Note: JSZip names usually include path like "folder/file.txt"
                                   // We need to recursively create parents. (Complex).
                                   // POTATO MODE: Flatten name, put in current PWD? 
                                   // OR just use full path concatenation: /Root/ + ZipPath
                                   
                                   return FS.writeFile(fullPath, b);
                               }));
